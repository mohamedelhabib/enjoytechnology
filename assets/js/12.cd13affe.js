(window.webpackJsonp=window.webpackJsonp||[]).push([[12],{378:function(t,s,a){"use strict";a.r(s);var e=a(47),n=Object(e.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h2",{attrs:{id:"introduction"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#introduction"}},[t._v("#")]),t._v(" Introduction")]),t._v(" "),a("p",[t._v("To run a Kubernetes into local machine you have several options.")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("Minikube")]),t._v(" is a virtual machine based solution.")]),t._v(" "),a("li",[a("code",[t._v("Microk8s")]),t._v(" is a snap package, available only in Ubuntu and compatible distributions")]),t._v(" "),a("li",[a("code",[t._v("Docker Desktop")]),t._v(" is an application for MacOS and Windows machines")])]),t._v(" "),a("p",[t._v("I this article we explore another option, "),a("a",{attrs:{href:"https://github.com/rancher/k3d",target:"_blank",rel:"noopener noreferrer"}},[t._v("k3d"),a("OutboundLink")],1),t._v(" a docker version of "),a("code",[t._v("k3s")]),t._v(", the lightweight Kubernetes distribution by Rancher.")]),t._v(" "),a("h3",{attrs:{id:"what-is-k3s-the-official-definition"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#what-is-k3s-the-official-definition"}},[t._v("#")]),t._v(" What is k3s (the official definition)")]),t._v(" "),a("p",[a("code",[t._v("k3s")]),t._v(" is a fully compliant Kubernetes distribution with the following changes:")]),t._v(" "),a("ol",[a("li",[t._v("Packaged as a single binary.")]),t._v(" "),a("li",[t._v("Lightweight storage backend based on sqlite3 as the default storage mechanism. etcd3, MySQL, Postgres also still available.")]),t._v(" "),a("li",[t._v("Wrapped in simple launcher that handles a lot of the complexity of TLS and options.")]),t._v(" "),a("li",[t._v("Secure by default with reasonable defaults for lightweight environments.")]),t._v(" "),a("li",[t._v("Minimal to no OS dependencies (just a sane kernel and cgroup mounts needed). k3s packages required\ndependencies\n"),a("ul",[a("li",[t._v("containerd")]),t._v(" "),a("li",[t._v("Flannel")]),t._v(" "),a("li",[t._v("CoreDNS")]),t._v(" "),a("li",[t._v("CNI")]),t._v(" "),a("li",[t._v("Host utilities (iptables, socat, etc)")]),t._v(" "),a("li",[t._v("Ingress controller (traefik)")]),t._v(" "),a("li",[t._v("Embedded service loadbalancer")]),t._v(" "),a("li",[t._v("Embedded network policy controller")])])])]),t._v(" "),a("h3",{attrs:{id:"what-is-k3d"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#what-is-k3d"}},[t._v("#")]),t._v(" What is k3d")]),t._v(" "),a("p",[a("code",[t._v("k3d")]),t._v(" is a "),a("code",[t._v("Go")]),t._v(" binary file that run "),a("code",[t._v("k3s")]),t._v(" in docker. A very simple installation way and no modification in your system just one docker container that contain the Kubernetes cluster.")]),t._v(" "),a("h2",{attrs:{id:"requirements"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#requirements"}},[t._v("#")]),t._v(" Requirements")]),t._v(" "),a("ul",[a("li",[t._v("docker")]),t._v(" "),a("li",[t._v("kubectl")]),t._v(" "),a("li",[t._v("java")]),t._v(" "),a("li",[a("a",{attrs:{href:"https://helm.sh/docs/intro/install/",target:"_blank",rel:"noopener noreferrer"}},[t._v("helm"),a("OutboundLink")],1)])]),t._v(" "),a("h2",{attrs:{id:"install-k3d"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#install-k3d"}},[t._v("#")]),t._v(" Install k3d")]),t._v(" "),a("p",[t._v("The installation script "),a("code",[t._v("install.sh")]),t._v(" will run the following steps")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("initArch "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# discovers the architecture for this system")]),t._v("\ninitOS "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# discovers the operating system for this system")]),t._v("\nverifySupported "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# checks that the os/arch combination is supported for binary builds")]),t._v("\ncheckTagProvided "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" checkLatestVersion\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v(" checkK3dInstalledVersion"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("then")]),t._v("\n  downloadFile "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# downloads the latest binary package and also the checksum")]),t._v("\n  installFile "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# make the Go binary file executable and mv it to /usr/local/bin/.")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("fi")]),t._v("\n")])])]),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("${K3D_INSTALL_DIR"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v('"'),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("usr"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("local"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v('bin"}')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\n"),a("span",{pre:!0,attrs:{class:"token function-name function"}},[t._v("installFile")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Preparing to install '),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$APP_NAME")]),t._v(" into "),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("${K3D_INSTALL_DIR}")]),t._v('"')]),t._v("\n  runAsRoot "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("chmod")]),t._v(" +x "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$K3D_TMP_FILE")]),t._v('"')]),t._v("\n  runAsRoot "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("cp")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$K3D_TMP_FILE")]),t._v('"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$K3D_INSTALL_DIR")]),t._v("/"),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$APP_NAME")]),t._v('"')]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$APP_NAME")]),t._v(" installed into "),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$K3D_INSTALL_DIR")]),t._v("/"),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$APP_NAME")]),t._v('"')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("To install "),a("code",[t._v("k3d")]),t._v(" run the following command")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" -s https://raw.githubusercontent.com/rancher/k3d/v1.7.0/install.sh "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("bash")]),t._v("\n")])])]),a("h2",{attrs:{id:"create-a-cluster"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#create-a-cluster"}},[t._v("#")]),t._v(" Create a cluster")]),t._v(" "),a("p",[t._v("To create a Kubernetes cluster run the following command")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ k3d create\nINFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("0000"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Created cluster network with ID aa64941776d3cfd783189cbb46c0abbee89074228d3f88d7748d17f28cc9f0ca \nINFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("0000"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Created docker volume  k3d-k3s-default-images \nINFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("0000"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Creating cluster "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("k3s-default"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("               \nINFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("0000"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Creating server using docker.io/rancher/k3s:v1.17.3-k3s1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(". \nINFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("0000"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Pulling image docker.io/rancher/k3s:v1.17.3-k3s1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(". \nINFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("0006"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" SUCCESS: created cluster "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("k3s-default"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("       \nINFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("0006"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" You can now use the cluster with:\n\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("export")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("KUBECONFIG")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$(")]),t._v("k3d get-kubeconfig --name"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'k3s-default'")]),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v(")")])]),t._v('"')]),t._v("\nkubectl cluster-info \n")])])]),a("p",[t._v("If you run the following command you can see that there are a "),a("code",[t._v("k3s")]),t._v(" docker image just pulled.")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ docker "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ps")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("grep")]),t._v(" k3s\nb0c341cbee7a        rancher/k3s:v1.17.3-k3s1   "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/bin/k3s server --h…"')]),t._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(" minutes ago       Up "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(" minutes        "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.0")]),t._v(".0.0:6443-"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6443")]),t._v("/tcp   k3d-k3s-default-server\n")])])]),a("p",[t._v("If you run the following command you can see that there are a "),a("code",[t._v("k3d-k3s...")]),t._v(" container running.")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ docker "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ps")]),t._v("\nCONTAINER ID        IMAGE                      COMMAND                  CREATED             STATUS              PORTS                    NAMES\nb0c341cbee7a        rancher/k3s:v1.17.3-k3s1   "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/bin/k3s server --h…"')]),t._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(" minutes ago       Up About a minute   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.0")]),t._v(".0.0:6443-"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6443")]),t._v("/tcp   k3d-k3s-default-server\n")])])]),a("h3",{attrs:{id:"generate-kubectl-configuration"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#generate-kubectl-configuration"}},[t._v("#")]),t._v(" Generate kubectl configuration")]),t._v(" "),a("p",[t._v("To user the Kubernetes cluster we need to tell kubectl where to find the config file.\n"),a("code",[t._v("k3d")]),t._v(" a command to get the config file location")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ k3d get-kubeconfig --name"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'k3s-default'")]),t._v("\n/home/"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v("/.config/k3d/k3s-default/kubeconfig.yaml\n")])])]),a("p",[t._v("We set this path into "),a("code",[t._v("KUBECONFIG")]),t._v(" kubectl environment variable")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("export")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("KUBECONFIG")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$(")]),t._v("k3d get-kubeconfig --name"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'k3s-default'")]),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v(")")])]),t._v('"')]),t._v("\n")])])]),a("h3",{attrs:{id:"check-that-the-cluster-is-running"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#check-that-the-cluster-is-running"}},[t._v("#")]),t._v(" Check that the cluster is running")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ kubectl get pod,svc --all-namespaces\nNAMESPACE     NAME                                          READY   STATUS      RESTARTS   AGE\nkube-system   pod/local-path-provisioner-58fb86bdfd-qrmmv   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running     "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          23m\nkube-system   pod/metrics-server-6d684c7b5-qk4pl            "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running     "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          23m\nkube-system   pod/helm-install-traefik-qb7mn                "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("/1     Completed   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          23m\nkube-system   pod/svclb-traefik-748m5                       "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("/2     Running     "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          23m\nkube-system   pod/coredns-d798c9dd-tth8c                    "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running     "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          23m\nkube-system   pod/traefik-6787cddb4b-qswjk                  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running     "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          23m\n\nNAMESPACE     NAME                         TYPE           CLUSTER-IP     EXTERNAL-IP   PORT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("S"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("                      AGE\ndefault       service/kubernetes           ClusterIP      "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.43")]),t._v(".0.1      "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("        "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("443")]),t._v("/TCP                      23m\nkube-system   service/kube-dns             ClusterIP      "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.43")]),t._v(".0.10     "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("        "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("53")]),t._v("/UDP,53/TCP,9153/TCP       23m\nkube-system   service/metrics-server       ClusterIP      "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.43")]),t._v(".94.13    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("        "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("443")]),t._v("/TCP                      23m\nkube-system   service/traefik-prometheus   ClusterIP      "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.43")]),t._v(".110.75   "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("        "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("9100")]),t._v("/TCP                     23m\nkube-system   service/traefik              LoadBalancer   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.43")]),t._v(".54.34    "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("172.19")]),t._v(".0.2    "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),t._v(":32219/TCP,443:32350/TCP   23m\n")])])]),a("h2",{attrs:{id:"build-and-deploy-demo-application"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#build-and-deploy-demo-application"}},[t._v("#")]),t._v(" Build and deploy demo application")]),t._v(" "),a("h3",{attrs:{id:"create-a-demo-application"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#create-a-demo-application"}},[t._v("#")]),t._v(" Create a demo application")]),t._v(" "),a("p",[t._v("Create an new spring-boot application using https://start.spring.io/.\nFor this tuto we will use an already prepared application from "),a("code",[t._v("demo-app")]),t._v(" folder.")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# checkout the 1.0 tag")]),t._v("\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" checkout "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1.0")]),t._v("\n")])])]),a("p",[t._v("At this step we have a very simple spring-boot application with")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("spring-boot-starter-web")]),t._v(" to run a tomcat server")]),t._v(" "),a("li",[a("code",[t._v("spring-boot-starter-actuator")]),t._v(" to get /actuator/info endpoint")])]),t._v(" "),a("p",[t._v("We are using the "),a("code",[t._v("jib-maven-plugin")]),t._v(" to generate the docker image. Please see the pom.xml for more details.")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ tree "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v("\n├── HELP.md\n├── k8s\n│   ├── 01_namespace.yml\n│   ├── 02_deployment.yml\n│   └── 03_service.yml\n├── mvnw\n├── mvnw.cmd\n├── pom.xml\n└── src\n    ├── main\n    │   ├── java\n    │   │   └── com\n    │   │       └── example\n    │   │           └── demoistio\n    │   │               └── DemoIstioApplication.java\n    │   └── resources\n    │       └── application.properties\n    └── "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("test")]),t._v("\n        └── java\n            └── com\n                └── example\n                    └── demoistio\n                        └── DemoIstioApplicationTests.java\n\n")])])]),a("h3",{attrs:{id:"build-the-demo-application"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#build-the-demo-application"}},[t._v("#")]),t._v(" Build the demo application")]),t._v(" "),a("p",[t._v("To build the application jar and docker image run the following command")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ ./mvnw clean package\n")])])]),a("p",[t._v("You can check that there are a docker image "),a("code",[t._v("com.example/demo-app")])]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ docker image "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ls")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("grep")]),t._v(" demo\ncom.example/demo-app          "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1.0")]),t._v("                     486ace0e9548        "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("50")]),t._v(" years ago        383MB\n")])])]),a("p",[t._v("To deploy our application into the Kubernetes cluster we have to make our local image available into the cluster.\nThis can be done by push the image to a remote docker registry or by using the import-images")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ k3d import-images com.example/demo-app:1.0\nINFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("0000"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Saving images "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("com.example/demo-app:1.0"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" from "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("local")]),t._v(" docker daemon"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(". \nINFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("0000"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Pulling image docker.io/iwilltry42/k3d-tools:v0.0.1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(". \nINFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("0006"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Saved images to shared docker volume         \nINFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("0006"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Importing images "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("com.example/demo-app:1.0"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" container "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("k3d-k3s-default-server"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" \nINFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("0011"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Successfully imported images "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("com.example/demo-app:1.0"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" all nodes of cluster "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("k3s-default"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" \nINFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("0011"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Cleaning up tarball                          \nINFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("0011"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Deleted tarball                              \nINFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("0011"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".Done \n")])])]),a("h3",{attrs:{id:"deploy-the-demo-application"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#deploy-the-demo-application"}},[t._v("#")]),t._v(" Deploy the demo application")]),t._v(" "),a("p",[t._v("Into k8s folder you can the k8s manifest we will use to deploy."),a("br"),t._v("\nThe demo-app will be deployed into namespace "),a("code",[t._v("api")])]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ tree k8s/\nk8s/\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# manifest to create the `api` namespace")]),t._v("\n├── 01_namespace.yml\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# manifest to create deploy container using the demo-app docker image")]),t._v("\n├── 02_deployment.yml\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# manifest to create a Kubernetes service ")]),t._v("\n└── 03_service.yml\n")])])]),a("p",[t._v("Fill free to check the content of YAML file")]),t._v(" "),a("p",[t._v("Run the following command to  deploy and wait to deployment to finish.\nWait until you see "),a("code",[t._v("1/1")]),t._v(" into READY columns, Tape "),a("code",[t._v("CTRL+C")]),t._v(" to stop waiting.")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ kubectl apply -R -f k8s "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" kubectl -n api get pods -w\nnamespace/api created\ndeployment.apps/demo-app-deployment created\nservice/demo-app-service created\nNAME                                  READY   STATUS              RESTARTS   AGE\ndemo-app-deployment-f444966fd-4qh5n   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("/1     ContainerCreating   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          0s\ndemo-app-deployment-f444966fd-4qh5n   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("/1   Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("     2s\ndemo-app-deployment-f444966fd-4qh5n   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1   Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("     5s\n")])])]),a("p",[t._v("To check pod is running and service is there run the following command")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ kubectl -n api get pods,svc\nNAME                                      READY   STATUS    RESTARTS   AGE\npod/demo-app-deployment-f444966fd-l6hn9   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          6m52s\n\nNAME                       TYPE        CLUSTER-IP     EXTERNAL-IP   PORT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("S"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("   AGE\nservice/demo-app-service   ClusterIP   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.43")]),t._v(".10.248   "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("        "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),t._v("/TCP    6m52s\n")])])]),a("p",[t._v("To check that application is running, we connect to the server docker container and run a simple http request.")]),t._v(" "),a("blockquote",[a("p",[t._v("NOTE that 10.43.10.248 is the IP show into CLUSTER-IP into previous command")])]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ docker "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("exec")]),t._v(" -ti k3d-k3s-default-server "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sh")]),t._v(" -c "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"wget -qSO- 10.43.10.248/actuator/info"')]),t._v("\n  HTTP/1.1 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("200")]),t._v(" \n  Content-Type: application/vnd.spring-boot.actuator.v3+json\n  Transfer-Encoding: chunked\n  Date: Fri, "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("15")]),t._v(" May "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2020")]),t._v(" 04:13:56 GMT\n  Connection: close\n  \n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"git"')]),t._v(":"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"branch"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"67f84b9744d014f558b95fb521266fa4fb00501a"')]),t._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"commit"')]),t._v(":"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"id"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"67f84b9"')]),t._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"time"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"2019-12-05T12:04:13Z"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h2",{attrs:{id:"deploy-istio-into-k3d"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#deploy-istio-into-k3d"}},[t._v("#")]),t._v(" Deploy Istio into k3d")]),t._v(" "),a("h3",{attrs:{id:"what-is-istio"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#what-is-istio"}},[t._v("#")]),t._v(" What is Istio")]),t._v(" "),a("p",[t._v("Istio provides behavioural insights and operational control over the service mesh as a whole, offering a complete solution to satisfy the diverse requirements of microservice applications.\nRead more about provided features here https://istio.io/docs/concepts/what-is-istio/")]),t._v(" "),a("h3",{attrs:{id:"disable-k3s-load-balancer-service"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#disable-k3s-load-balancer-service"}},[t._v("#")]),t._v(" Disable "),a("code",[t._v("k3s")]),t._v(" load balancer service")]),t._v(" "),a("p",[a("code",[t._v("k3s")]),t._v(" and "),a("code",[t._v("k3d")]),t._v(" come with preconfigured load balancer service, this is fine for default usage, but to be able de use istio we have to disable this service.\nUnfortunately "),a("code",[t._v("k3s")]),t._v(" don't provide an update cluster option, so we have to recreate the cluster. More details into this github issue https://github.com/rancher/k3d/issues/104")]),t._v(" "),a("p",[t._v("Hopefully this very easy and quick to do.")]),t._v(" "),a("p",[t._v("Run this command to delete the cluster.")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ k3d delete\nINFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("0000"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Removing cluster "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("k3s-default"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("               \nINFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("0000"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".Removing server                           \nINFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("0002"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".Removing docker image volume              \nINFO"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("0002"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" Removed cluster "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("k3s-default"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("    \n")])])]),a("p",[t._v("Run this command to create the cluster without the load balancer service.")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ k3d create --server-arg --no-deploy --server-arg servicelb\n")])])]),a("p",[t._v("Run the following commands to deploy the application")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ k3d import-images com.example/demo-app:1.0\n$ "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("export")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("KUBECONFIG")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$(")]),t._v("k3d get-kubeconfig --name"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'k3s-default'")]),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v(")")])]),t._v('"')]),t._v("\n$ kubectl apply -R -f k8s "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" kubectl -n api get pods -w\n")])])]),a("h3",{attrs:{id:"download-and-extract-istio"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#download-and-extract-istio"}},[t._v("#")]),t._v(" Download and extract Istio")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" https://github.com/istio/istio/releases/download/1.5.4/istio-1.5.4-linux.tar.gz -L "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("tar")]),t._v(" xvz\n")])])]),a("h3",{attrs:{id:"create-a-namespace-for-istio"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#create-a-namespace-for-istio"}},[t._v("#")]),t._v(" Create a namespace for istio")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" istio-1.5.4\n$ kubectl create namespace istio-system\nnamespace/istio-system created\n")])])]),a("h3",{attrs:{id:"install-istio-init"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#install-istio-init"}},[t._v("#")]),t._v(" Install istio-init")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ helm template istio-init install/kubernetes/helm/istio-init  --namespace istio-system "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" kubectl apply -f -\nserviceaccount/istio-init-service-account created\nconfigmap/istio-crd-all created\nconfigmap/istio-crd-mixer created\nclusterrole.rbac.authorization.k8s.io/istio-init-istio-system created\nclusterrolebinding.rbac.authorization.k8s.io/istio-init-admin-role-binding-istio-system created\njob.batch/istio-init-crd-all-1.5.4 created\njob.batch/istio-init-crd-mixer-1.5.4 created\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Wait that `istio-init-crd` are `Completed` ")]),t._v("\n$ kubectl get pod,svc -n istio-system \nNAME                                   READY   STATUS      RESTARTS   AGE\npod/istio-init-crd-mixer-1.5.4-6hjst   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("/1     Completed   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          50s\npod/istio-init-crd-all-1.5.4-qlfdp     "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("/1     Completed   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          50s\n")])])]),a("h3",{attrs:{id:"install-istio"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#install-istio"}},[t._v("#")]),t._v(" Install Istio")]),t._v(" "),a("p",[t._v("At this step we will install Istio with "),a("code",[t._v("Kiali")]),t._v(" (an observability console for Istio).")]),t._v(" "),a("p",[t._v("To activate this console we need to provide a login/password")]),t._v(" "),a("p",[t._v("Using kubectl we create a "),a("code",[t._v("Keberntes Secret")]),t._v(" containing the username and passphrase for "),a("code",[t._v("Kiali")])]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("cat")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v("EOF "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" kubectl apply -f -\napiVersion: v1\nkind: Secret\nmetadata:\n  name: kiali\n  namespace: istio-system\n  labels:\n    app: kiali\ntype: Opaque\ndata:\n  username: "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("YWRtaW4")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("\n  passphrase: "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("YWRtaW4")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("\nEOF\n")])])]),a("p",[t._v("Using helm we deploy the chart of "),a("code",[t._v("Istio")])]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ helm template istio install/kubernetes/helm/istio --namespace istio-system --set kiali.enabled"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("true "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" kubectl apply -f -\noddisruptionbudget.policy/istio-galley created\npoddisruptionbudget.policy/istio-ingressgateway created\npoddisruptionbudget.policy/istio-policy created\npoddisruptionbudget.policy/istio-telemetry created\npoddisruptionbudget.policy/istio-pilot created\npoddisruptionbudget.policy/istio-citadel created\npoddisruptionbudget.policy/istio-sidecar-injector created\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\nrule.config.istio.io/promhttp created\nrule.config.istio.io/promtcp created\nrule.config.istio.io/promtcpconnectionopen created\nrule.config.istio.io/promtcpconnectionclosed created\nrule.config.istio.io/kubeattrgenrulerule created\nrule.config.istio.io/tcpkubeattrgenrulerule created\njob.batch/istio-security-post-install-1.5.4 created\n")])])]),a("p",[t._v("check that every thing is OK (status should be Completed or Running)")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ kubectl get pod,svc -n istio-system \nNAME                                          READY   STATUS      RESTARTS   AGE\npod/istio-init-crd-mixer-1.5.4-t5mjk          "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("/1     Completed   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          111s\npod/istio-init-crd-all-1.5.4-7phvs            "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("/1     Completed   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          111s\npod/istio-citadel-5449c98845-cf7bb            "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running     "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          55s\npod/svclb-istio-ingressgateway-czd64          "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("9")]),t._v("/9     Running     "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          55s\npod/istio-telemetry-85c9dfddb7-nx42k          "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("/2     Running     "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("          55s\npod/istio-policy-5db987b9dc-mmzgk             "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("/2     Running     "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("          55s\npod/istio-galley-554d6d4cfb-sjq87             "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running     "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          55s\npod/kiali-9fc79f8b8-rxc7n                     "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running     "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          55s\npod/istio-sidecar-injector-85b6d84b84-72cfj   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running     "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          54s\npod/prometheus-794594dc97-s5p2g               "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running     "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          55s\npod/istio-security-post-install-1.5.4-krv64   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("/1     Completed   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          35s\npod/istio-pilot-786558d87b-hrs9f              "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("/2     Running     "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("          55s\npod/istio-ingressgateway-644cd99cfd-xsl6m     "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running     "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          55s\n\nNAME                             TYPE           CLUSTER-IP      EXTERNAL-IP   PORT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("S"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("                                                                                                                                      AGE\nservice/istio-galley             ClusterIP      "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.43")]),t._v(".62.172    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("        "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("443")]),t._v("/TCP,15014/TCP,9901/TCP                                                                                                                   55s\nservice/kiali                    ClusterIP      "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.43")]),t._v(".55.178    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("        "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("20001")]),t._v("/TCP                                                                                                                                    55s\nservice/istio-policy             ClusterIP      "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.43")]),t._v(".81.255    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("        "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("9091")]),t._v("/TCP,15004/TCP,15014/TCP                                                                                                                 55s\nservice/istio-telemetry          ClusterIP      "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.43")]),t._v(".48.138    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("        "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("9091")]),t._v("/TCP,15004/TCP,15014/TCP,42422/TCP                                                                                                       55s\nservice/istio-pilot              ClusterIP      "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.43")]),t._v(".33.93     "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("        "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("15010")]),t._v("/TCP,15011/TCP,8080/TCP,15014/TCP                                                                                                       55s\nservice/prometheus               ClusterIP      "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.43")]),t._v(".82.109    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("        "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("9090")]),t._v("/TCP                                                                                                                                     55s\nservice/istio-citadel            ClusterIP      "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.43")]),t._v(".177.192   "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("        "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8060")]),t._v("/TCP,15014/TCP                                                                                                                           55s\nservice/istio-sidecar-injector   ClusterIP      "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.43")]),t._v(".31.119    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("        "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("443")]),t._v("/TCP,15014/TCP                                                                                                                            55s\nservice/istio-ingressgateway     LoadBalancer   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.43")]),t._v(".105.148   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("172.21")]),t._v(".0.2    "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("15020")]),t._v(":30892/TCP,80:31380/TCP,443:31390/TCP,31400:31400/TCP,15029:31994/TCP,15030:32199/TCP,15031:30538/TCP,15032:30545/TCP,15443:30726/TCP   55s\n\n")])])]),a("h3",{attrs:{id:"test-with-istio-demo-application"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#test-with-istio-demo-application"}},[t._v("#")]),t._v(" Test with istio demo application")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ kubectl label namespace default istio-injection"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("enabled\n$ kubectl apply -f samples/bookinfo/platform/kube/bookinfo.yaml\n$ kubectl get pods -w\n$ kubectl apply -f samples/bookinfo/networking/bookinfo-gateway.yaml\n$ kubectl get svc  -n istio-system istio-ingressgateway -o "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("jsonpath")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'{.status.loadBalancer.ingress[0].ip}'")]),t._v("\n")])])]),a("p",[t._v("Goto this url to check istio demo working "),a("a",{attrs:{href:""}},[t._v("http://{The IP Address}/productpage")]),t._v("\nRefersh several time and you should see three version of the review star")]),t._v(" "),a("ul",[a("li",[t._v("black")]),t._v(" "),a("li",[t._v("orange")]),t._v(" "),a("li",[t._v("and none\nIn fact the istio bookinfo application contains three versions of the review service")])]),t._v(" "),a("h3",{attrs:{id:"acces-kiali-dashboard"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#acces-kiali-dashboard"}},[t._v("#")]),t._v(" Acces Kiali dashboard")]),t._v(" "),a("p",[t._v("Run this command to access the "),a("code",[t._v("Kiali")]),t._v(" dashboard. it will create a port forward and open the right url into navigator.")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ ./bin/istioctl dashboard kiali\n")])])]),a("p",[t._v("You should see some thing like this.")]),t._v(" "),a("ul",[a("li",[t._v("1 application into "),a("code",[t._v("api")]),t._v(" namespace, ower demo application")]),t._v(" "),a("li",[t._v("4 application into "),a("code",[t._v("default")]),t._v(", the istio demo application")]),t._v(" "),a("li",[t._v("10 application into "),a("code",[t._v("istio-system")]),t._v(", the istio container")])]),t._v(" "),a("p",[a("img",{attrs:{src:"/assets/img/kiali-dashboard.png",alt:""}})]),t._v(" "),a("h2",{attrs:{id:"use-isto-for-the-demo-application"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#use-isto-for-the-demo-application"}},[t._v("#")]),t._v(" Use Isto for the demo application")]),t._v(" "),a("h3",{attrs:{id:"enable-istio-injection-into-demo-app"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#enable-istio-injection-into-demo-app"}},[t._v("#")]),t._v(" Enable "),a("code",[t._v("istio-injection")]),t._v(" into "),a("code",[t._v("demo-app")])]),t._v(" "),a("p",[t._v("Into this version "),a("code",[t._v("1.0-istio-injectio-on")]),t._v(" we enable the "),a("code",[t._v("istio-injection")]),t._v(" by added a label into namespace "),a("code",[t._v("api")])]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" checkout "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1.0")]),t._v("-istio-injectio-on\n\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("diff")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1.0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1.0")]),t._v("-istio-injectio-on \n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("diff")]),t._v(" --git a/k8s/01_namespace.yml b/k8s/01_namespace.yml\nindex b61d02d"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v("6bd1bae "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("100644")]),t._v("\n--- a/k8s/01_namespace.yml\n+++ b/k8s/01_namespace.yml\n@@ -2,7 +2,7 @@\n apiVersion: v1\n kind: Namespace\n metadata:\n-  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# labels:")]),t._v("\n-  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#   # enable istio injection into the new namespace")]),t._v("\n-  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#   istio-injection: enabled")]),t._v("\n-  name: api\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v(" No newline at end of "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("file")]),t._v("\n+  labels:\n+    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# enable istio injection into the new namespace")]),t._v("\n+    istio-injection: enabled\n+  name: api\n")])])]),a("p",[t._v("When we apply this modification, we can see that only namespace change\npod is not updated.")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ kubectl apply -R -f k8s "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" kubectl -n api get pods\nnamespace/api configured\ndeployment.apps/demo-app-deployment unchanged\nservice/demo-app-service unchanged\nNAME                                  READY   STATUS    RESTARTS   AGE\ndemo-app-deployment-f444966fd-4qh5n   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          61m\n")])])]),a("p",[t._v("We need to restart pods to make the change applied. There are no restart command provided by kubectl. To achieve that we patch the deployment by adding a label this will make k8s create a new revision with the same image version")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ kubectl patch -n api deployment demo-app-deployment -p   "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"{'),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[t._v('\\"')]),t._v("spec"),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[t._v('\\"')]),t._v(":{"),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[t._v('\\"')]),t._v("template"),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[t._v('\\"')]),t._v(":{"),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[t._v('\\"')]),t._v("metadata"),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[t._v('\\"')]),t._v(":{"),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[t._v('\\"')]),t._v("annotations"),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[t._v('\\"')]),t._v(":{"),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[t._v('\\"')]),t._v("restart_date"),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[t._v('\\"')]),t._v(":"),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[t._v('\\"')]),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$(")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("date")]),t._v(" +"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'%s'")]),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v(")")])]),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[t._v('\\"')]),t._v('}}}}}"')]),t._v("\n\ndeployment.apps/demo-app-deployment patched\n\n$ kubectl -n api get pods \nNAME                                   READY   STATUS    RESTARTS   AGE\ndemo-app-deployment-577f556689-tlpnn   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("/2     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          18s\n")])])]),a("p",[t._v("You can see that the pod name has changed and under "),a("code",[t._v("READY")]),t._v(" we have "),a("code",[t._v("2/2")]),t._v(" instead of "),a("code",[t._v("1/1")]),t._v(".\nWe can see that there are a new container called "),a("code",[t._v("istio-proxy")])]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ kubectl -n api get pods demo-app-deployment-577f556689-tlpnn -o json "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" jq -r .spec.containers"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(".name\ndemo-app\nistio-proxy\n")])])]),a("h3",{attrs:{id:"configuring-ingress-using-an-istio-gateway"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#configuring-ingress-using-an-istio-gateway"}},[t._v("#")]),t._v(" Configuring ingress using an Istio gateway")]),t._v(" "),a("p",[t._v("To expose the "),a("code",[t._v("demo-app")]),t._v(" outside the k8s cluster we need an "),a("code",[t._v("Istio Gateway")]),t._v(" and an "),a("code",[t._v("Istio VirtualService")]),t._v(". An ingress Gateway describes a load balancer operating at the edge of the mesh that receives incoming HTTP/TCP connections. It configures exposed ports, protocols, etc. but, unlike Kubernetes Ingress Resources, does not include any traffic routing configuration. Traffic routing for ingress traffic is instead configured using Istio routing rules, exactly in the same way as for internal service requests.")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" checkout "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1.0")]),t._v("-istio-gateway-as-ingress\n")])])]),a("p",[t._v("This version add a new file k8s/04_gateway.yml, that contains the definition of the "),a("code",[t._v("demo-app-gateway")]),t._v(" and the "),a("code",[t._v("demo-app-route")]),t._v(". We only expose the "),a("code",[t._v("/actuator/*")]),t._v(" endpoints.")]),t._v(" "),a("h4",{attrs:{id:"apply-changes"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#apply-changes"}},[t._v("#")]),t._v(" Apply changes")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ kubectl apply -R -f k8s \nnamespace/api unchanged\ndeployment.apps/demo-app-deployment unchanged\nservice/demo-app-service unchanged\ngateway.networking.istio.io/demo-app-gateway created\nvirtualservice.networking.istio.io/demo-app-route created\n\n")])])]),a("h4",{attrs:{id:"check-that-gateway-is-there"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#check-that-gateway-is-there"}},[t._v("#")]),t._v(" check that gateway is there")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ kubectl get gateway -n api\nNAME               AGE\ndemo-app-gateway   77s\n\n")])])]),a("h4",{attrs:{id:"check-that-virtualservice-is-there"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#check-that-virtualservice-is-there"}},[t._v("#")]),t._v(" check that virtualservice is there")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ kubectl get virtualservices.networking.istio.io -n api\nNAME             GATEWAYS             HOSTS   AGE\ndemo-app-route   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("demo-app-gateway"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("*"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("     89s\n\n")])])]),a("h4",{attrs:{id:"get-the-external-ip-of-the-istio-ingressgateway"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#get-the-external-ip-of-the-istio-ingressgateway"}},[t._v("#")]),t._v(" get the external IP of the istio-ingressgateway")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ kubectl get svc  -n istio-system istio-ingressgateway -o "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("jsonpath")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'{.status.loadBalancer.ingress[0].ip}'")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("172.24")]),t._v(".0.2\n\n")])])]),a("h4",{attrs:{id:"check-that-demo-app-is-accessible-from-outsie-the-k8s-cluster"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#check-that-demo-app-is-accessible-from-outsie-the-k8s-cluster"}},[t._v("#")]),t._v(" check that "),a("code",[t._v("demo-app")]),t._v(" is accessible from outsie the k8s cluster")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" -v -s "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("172.24")]),t._v(".0.2/actuator/info\n*   Trying "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("172.24")]),t._v(".0.2:80"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\n* TCP_NODELAY "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("set")]),t._v("\n* Connected to "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("172.24")]),t._v(".0.2 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("172.24")]),t._v(".0.2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" port "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#0)")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" GET /actuator/info HTTP/1.1\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" Host: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("172.24")]),t._v(".0.2\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" User-Agent: curl/7.65.3\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" Accept: */*\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" \n* Mark bundle as not supporting multiuse\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" HTTP/1.1 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("200")]),t._v(" OK\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" content-type: application/vnd.spring-boot.actuator.v3+json\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" date: Thu, 05 Dec "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2019")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("16")]),t._v(":02:39 GMT\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" x-envoy-upstream-service-time: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" server: istio-envoy\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" transfer-encoding: chunked\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" \n* Connection "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#0 to host 172.24.0.2 left intact")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"git"')]),t._v(":"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"branch"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"67f84b9744d014f558b95fb521266fa4fb00501a"')]),t._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"commit"')]),t._v(":"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"id"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"67f84b9"')]),t._v(","),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"time"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"2019-12-05T12:04:13Z"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h3",{attrs:{id:"api-versionning"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#api-versionning"}},[t._v("#")]),t._v(" Api versionning")]),t._v(" "),a("h4",{attrs:{id:"version-1"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#version-1"}},[t._v("#")]),t._v(" Version 1")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" checkout "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1.1")]),t._v("\n")])])]),a("p",[t._v("This version contains a new Rest endpoint that generate a random name.")]),t._v(" "),a("h5",{attrs:{id:"build-the-version-1-1-of-the-docker-image"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#build-the-version-1-1-of-the-docker-image"}},[t._v("#")]),t._v(" build the version 1.1 of the docker image")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ ./mvnw clean package\n\n$ docker image "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ls")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("grep")]),t._v(" demo\ncom.example/demo-app          "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1.0")]),t._v("                     486ace0e9548        "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("50")]),t._v(" years ago        383MB\ncom.example/demo-app          "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1.1")]),t._v("                     05a5c689c1b7        "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("50")]),t._v(" years ago        385MB\n")])])]),a("blockquote",[a("p",[t._v("the deployment.yml reference now the 1.1 version of the image.\nWe need to import this new version into k3s cluster.\nWe have to update the "),a("code",[t._v("virtualservice")]),t._v(" to be able to reach the new '/v1/hello' endpoint")])]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ k3d import-images com.example/demo-app:1.1\n\n")])])]),a("h5",{attrs:{id:"deploy-version-1-1"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#deploy-version-1-1"}},[t._v("#")]),t._v(" Deploy version 1.1")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ kubectl apply -R -f k8s\nnamespace/api unchanged\ndeployment.apps/demo-app-deployment configured\nservice/demo-app-service unchanged\ngateway.networking.istio.io/demo-app-gateway unchanged\nvirtualservice.networking.istio.io/demo-app-route configured\n\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" -v -s "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("172.24")]),t._v(".0.2/v1/hello\n*   Trying "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("172.24")]),t._v(".0.2:80"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\n* TCP_NODELAY "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("set")]),t._v("\n* Connected to "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("172.24")]),t._v(".0.2 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("172.24")]),t._v(".0.2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" port "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#0)")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" GET /v1/hello HTTP/1.1\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" Host: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("172.24")]),t._v(".0.2\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" User-Agent: curl/7.65.3\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" Accept: */*\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" \n* Mark bundle as not supporting multiuse\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" HTTP/1.1 "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("200")]),t._v(" OK\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" content-type: text/plain"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("charset")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("UTF-8\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" content-length: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("18")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" date: Thu, 05 Dec "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2019")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("17")]),t._v(":52:10 GMT\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" x-envoy-upstream-service-time: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" server: istio-envoy\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" \n* Connection "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#0 to host 172.24.0.2 left intact")]),t._v("\nHello, Mel Maggio"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("\n")])])]),a("h4",{attrs:{id:"version-1-and-version-2-canary-release"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#version-1-and-version-2-canary-release"}},[t._v("#")]),t._v(" Version 1 and Version 2 canary release")]),t._v(" "),a("p",[t._v("When migrating from version 1 to version 2 of an API, We need to give time to client of this API to migrate, So we need to have the two version of API running together.\nTo do that we will have to deployment, one for each version.")]),t._v(" "),a("h5",{attrs:{id:"get-version-1-2-code"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#get-version-1-2-code"}},[t._v("#")]),t._v(" Get version 1.2 code")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" checkout "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1.2")]),t._v("\n")])])]),a("blockquote",[a("p",[t._v("Note the "),a("code",[t._v("version")]),t._v(" label: this is very important for Istio to distinguish between the two deployments")])]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("---")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" apps/v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Deployment\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" demo"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("deployment"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("...")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("template")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" demo"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("app\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("version")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" v1.1\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("containers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" demo"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("app\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" com.example/demo"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1.1")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("---")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" apps/v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Deployment\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" demo"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("deployment"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("v2\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("...")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("template")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" demo"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("app\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("version")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" v1.2\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("containers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" demo"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("app\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" com.example/demo"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1.2")]),t._v("\n")])])]),a("p",[t._v("No big change to do into the kubernetes "),a("code",[t._v("service")])]),t._v(" "),a("blockquote",[a("p",[t._v("Note that the port is named (“name: http”). This is a requirement for Istio.")])]),t._v(" "),a("blockquote",[a("p",[t._v("The selector is only using the "),a("code",[t._v("demo-app")]),t._v(" label. Without Istio it will distribute traffic between the two deployments evenly.")])]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Service\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("namespace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" api\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" demo"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("service\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" demo"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("app\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ports")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("port")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" http\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("targetPort")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("8080")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("type")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ClusterIP\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("selector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" demo"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("app\n")])])]),a("p",[t._v("For "),a("code",[t._v("VirtualService")]),t._v(" side, we use the subset. A subset/version of a route destination is identified with a reference to a named service subset which must be declared in a corresponding DestinationRule.")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[t._v("  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("http")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("match")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("uri")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("prefix")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" /v1\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("route")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("destination")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("host")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" demo"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("service\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("subset")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" v1\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("port")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("number")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("match")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("uri")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("prefix")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" /v2\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("route")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("destination")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("host")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" demo"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("service\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("subset")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" v2\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("port")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("number")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),t._v("\n")])])]),a("p",[t._v("And here the definition of DestinationRule that make the mapping between "),a("code",[t._v("Sebset/version")]),t._v(" and "),a("code",[t._v("pods/version")])]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" networking.istio.io/v1alpha3\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" DestinationRule\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" demo"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("rules\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("namespace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" api\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("host")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" demo"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("service\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("subsets")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" v1\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("version")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" v1\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" v2\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("version")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" v2\n\n")])])]),a("h5",{attrs:{id:"build-the-version-1-2-of-the-docker-image"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#build-the-version-1-2-of-the-docker-image"}},[t._v("#")]),t._v(" Build the version 1.2 of the docker image")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ ./mvnw clean package\n$ k3d import-images com.example/demo-app:1.2\n")])])]),a("h5",{attrs:{id:"deploy-version-1-2-and-1-1"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#deploy-version-1-2-and-1-1"}},[t._v("#")]),t._v(" Deploy version 1.2 and 1.1")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ kubectl apply -R -f k8s\nnamespace/api unchanged\ndeployment.apps/demo-app-deployment-v1 created\ndeployment.apps/demo-app-deployment-v2 created\nservice/demo-app-service configured\ngateway.networking.istio.io/demo-app-gateway unchanged\nvirtualservice.networking.istio.io/demo-app-route configured\ndestinationrule.networking.istio.io/demo-app-rules created\n")])])]),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("$ kubectl apply -R -f k8s "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" kubectl -n api get pods\nnamespace/api unchanged\ndeployment.apps/demo-app-deployment-v1 unchanged\ndeployment.apps/demo-app-deployment-v2 unchanged\nservice/demo-app-service unchanged\ngateway.networking.istio.io/demo-app-gateway unchanged\nvirtualservice.networking.istio.io/demo-app-route unchanged\ndestinationrule.networking.istio.io/demo-app-rules unchanged\nNAME                                      READY   STATUS    RESTARTS   AGE\ndemo-app-deployment-c644498c8-6gln5       "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("/2     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          27m\ndemo-app-deployment-v1-5fb699f946-j5vrg   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("/2     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          94s\ndemo-app-deployment-v2-5b7dd595fb-45lzp   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("/2     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("          94s\n")])])]),a("h2",{attrs:{id:"references"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#references"}},[t._v("#")]),t._v(" References")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://dev.to/bufferings/tried-k8s-istio-in-my-local-machine-with-k3d-52gg",target:"_blank",rel:"noopener noreferrer"}},[t._v("Tried k8s + Istio on my laptop with k3d"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://haralduebele.blog/2019/03/11/managing-microservices-traffic-with-istio/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Managing Microservices Traffic with Istio"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://istio.io/docs/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Istio Docs"),a("OutboundLink")],1)])])])}),[],!1,null,null,null);s.default=n.exports}}]);