<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Secure API by OpenId Connect using Spring Security | Enjoy Technology</title>
    <meta name="generator" content="VuePress 1.5.0">
    <link rel="manifest" href="/assets/manifest.json">
    <link rel="apple-touch-icon" sizes="57x57" href="/assets/icons/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/assets/icons/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/assets/icons/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/assets/icons/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/assets/icons/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/assets/icons/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/assets/icons/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/assets/icons/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/assets/icons/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/icons/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/assets/icons/favicon-96x96.png">
    <link rel="preconnect" href="https://www.google-analytics.com">
    <link rel="preconnect" href="https://storage.googleapis.com">
    <meta name="description" content="A set of posts to share technology finding and help to get started">
    <meta name="theme-color" content="#ffffff">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Enjoy Technology">
    <meta name="application-name" content="Enjoy Technology">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-config" content="/assets/ieconfig.xml">
    <meta name="msapplication-TileImage" content="/assets/icons/ms-icon-144x144.png">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="google-site-verification" content="vaHfBtNF19BYEIpHn505BzxJ8a6lWlV6JO2GOdqptfY">
    <link rel="preload" href="/assets/css/0.styles.05b5abf3.css" as="style"><link rel="preload" href="/assets/js/app.8bb2a787.js" as="script"><link rel="preload" href="/assets/js/4.c6323ad2.js" as="script"><link rel="preload" href="/assets/js/2.79e1ebb6.js" as="script"><link rel="preload" href="/assets/js/10.efdfd574.js" as="script"><link rel="preload" href="/assets/js/6.d7f91b89.js" as="script"><link rel="prefetch" href="/assets/js/11.af07a843.js"><link rel="prefetch" href="/assets/js/12.cd13affe.js"><link rel="prefetch" href="/assets/js/13.39b88b44.js"><link rel="prefetch" href="/assets/js/14.a9fa26a6.js"><link rel="prefetch" href="/assets/js/15.c0b71d42.js"><link rel="prefetch" href="/assets/js/3.8bab5a9e.js"><link rel="prefetch" href="/assets/js/5.f132e9b5.js"><link rel="prefetch" href="/assets/js/7.ada2a324.js"><link rel="prefetch" href="/assets/js/8.724a125e.js"><link rel="prefetch" href="/assets/js/9.2d0a0718.js">
    <link rel="stylesheet" href="/assets/css/0.styles.05b5abf3.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/assets/icons/favicon-32x32.png" alt="Enjoy Technology" class="logo"> <span class="site-name can-hide">Enjoy Technology</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Secure API by OpenId Connect using Spring Security</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/2020/05/10/secure-api-using-openid-connect-and-spring-security/#description" class="sidebar-link">Description</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/2020/05/10/secure-api-using-openid-connect-and-spring-security/#prerequisite" class="sidebar-link">Prerequisite</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/2020/05/10/secure-api-using-openid-connect-and-spring-security/#run-stack" class="sidebar-link">Run stack</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/2020/05/10/secure-api-using-openid-connect-and-spring-security/#build-application-code-and-docker-image" class="sidebar-link">Build application code and docker image</a></li><li class="sidebar-sub-header"><a href="/2020/05/10/secure-api-using-openid-connect-and-spring-security/#run-the-application-and-the-keycloak-instance" class="sidebar-link">Run the application and the keycloak instance</a></li><li class="sidebar-sub-header"><a href="/2020/05/10/secure-api-using-openid-connect-and-spring-security/#_1-check-that-the-keycloak-is-up-and-runnning" class="sidebar-link">1. Check that the keycloak is up and runnning.</a></li><li class="sidebar-sub-header"><a href="/2020/05/10/secure-api-using-openid-connect-and-spring-security/#_2-check-that-application-is-up-and-running" class="sidebar-link">2. Check that application is up and running</a></li></ul></li><li><a href="/2020/05/10/secure-api-using-openid-connect-and-spring-security/#test-stack" class="sidebar-link">Test stack</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/2020/05/10/secure-api-using-openid-connect-and-spring-security/#_1-generate-a-jwt-token" class="sidebar-link">1. Generate a JWT token :</a></li><li class="sidebar-sub-header"><a href="/2020/05/10/secure-api-using-openid-connect-and-spring-security/#_2-redirect-to-login-page-anonymous-user" class="sidebar-link">2. Redirect to login page anonymous user</a></li><li class="sidebar-sub-header"><a href="/2020/05/10/secure-api-using-openid-connect-and-spring-security/#_3-role-are-respected" class="sidebar-link">3. Role are respected</a></li></ul></li><li><a href="/2020/05/10/secure-api-using-openid-connect-and-spring-security/#code-explanation" class="sidebar-link">Code explanation</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/2020/05/10/secure-api-using-openid-connect-and-spring-security/#_1-protect-the-application-with-an-openid-provider" class="sidebar-link">1. Protect the application with an OpenId provider</a></li><li class="sidebar-sub-header"><a href="/2020/05/10/secure-api-using-openid-connect-and-spring-security/#_2-add-authentification-based-on-authorization-header" class="sidebar-link">2. Add authentification based on Authorization header</a></li><li class="sidebar-sub-header"><a href="/2020/05/10/secure-api-using-openid-connect-and-spring-security/#_3-modify-default-configuration" class="sidebar-link">3. modify default configuration</a></li><li class="sidebar-sub-header"><a href="/2020/05/10/secure-api-using-openid-connect-and-spring-security/#_4-added-authentication-using-cookie" class="sidebar-link">4. added authentication using cookie</a></li></ul></li><li><a href="/2020/05/10/secure-api-using-openid-connect-and-spring-security/#reference-documentation" class="sidebar-link">Reference Documentation</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/2020/05/10/secure-api-using-openid-connect-and-spring-security/#launch-into-ide" class="sidebar-link">Launch into IDE</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/2020/05/10/secure-api-using-openid-connect-and-spring-security/#source-code" class="sidebar-link">Source code</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/2020/05/10/secure-api-using-openid-connect-and-spring-security/#todo" class="sidebar-link">TODO</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> <footer class="footer" data-v-d9212786><ul class="sidebar-social" data-v-d9212786><li class="contact-item" data-v-d9212786><a href="https://github.com/mohamedelhabib" title="github" data-v-d9212786><svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github" data-v-d9212786 data-v-d9212786><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22" data-v-d9212786 data-v-d9212786></path></svg>
        github
      </a></li><li class="contact-item" data-v-d9212786><a href="https://twitter.com/elhabib_med" title="twitter" data-v-d9212786><svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-twitter" data-v-d9212786 data-v-d9212786><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z" data-v-d9212786 data-v-d9212786></path></svg>
        twitter
      </a></li><li class="contact-item" data-v-d9212786><a href="https://www.linkedin.com/in/mohamed-el-habib-77165222" title="linkedin" data-v-d9212786><svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-linkedin" data-v-d9212786 data-v-d9212786><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z" data-v-d9212786 data-v-d9212786></path><rect x="2" y="9" width="4" height="12" data-v-d9212786 data-v-d9212786></rect><circle cx="4" cy="4" r="2" data-v-d9212786 data-v-d9212786></circle></svg>
        linkedin
      </a></li></ul> <div class="copyright" data-v-d9212786>MIT Licensed | Copyright © 2020-present</div></footer></aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="description"><a href="#description" class="header-anchor">#</a> Description</h2> <p>This is an exemple of Rest API were some endpoints are secured by an OpenId Connect
This application contains two endpoints</p> <ul><li><code>/</code> is a public endpoint</li> <li><code>/api/private</code> is a private endpoint
<ul><li>this endpoint is callable using
<ul><li><code>GET</code> verb : only authenticated user with <code>reader</code> or <code>writer</code> role can call.</li> <li><code>POST</code> verb : only authenticated user with <code>writer</code> role can call.</li></ul></li></ul></li></ul> <div class="language-java extra-class"><pre class="language-java"><code>	<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">publicEndpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token string">&quot;Hello Public Ok&quot;</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token annotation punctuation">@RolesAllowed</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token string">&quot;ROLE_reader&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ROLE_writer&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/api/private&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">public</span> <span class="token class-name">Authentication</span> <span class="token function">privateEndpoint</span><span class="token punctuation">(</span><span class="token class-name">Authentication</span> authentication<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> authentication<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@RolesAllowed</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token string">&quot;ROLE_writer&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/api/private&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">privateEndpointWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token string">&quot;done&quot;</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre></div><p>For this excercice we are using <code>keycloak</code> as OpenId provider.
This exemple inclu preconfigured <code>keycloak</code> instance (h2 db is provided into <code>src/docker/keycloak.mv.db</code>). This instance contains</p> <ul><li>a <code>organisation</code> realm</li> <li>a <code>client1</code> client inside the <code>organisation</code> realm</li> <li>two roles <code>reader</code> and <code>writer</code></li> <li>three users with the same password <code>password</code> :
<ul><li><code>test</code> having the <code>writer</code> role</li> <li><code>test2</code> having the <code>reader</code> role</li> <li><code>test3</code> without role</li></ul></li></ul> <h2 id="prerequisite"><a href="#prerequisite" class="header-anchor">#</a> Prerequisite</h2> <p>To use this app the following prerequisite are needed :</p> <ul><li>docker</li> <li>docker-compose</li> <li>openjdk</li></ul> <h2 id="run-stack"><a href="#run-stack" class="header-anchor">#</a> Run stack</h2> <h3 id="build-application-code-and-docker-image"><a href="#build-application-code-and-docker-image" class="header-anchor">#</a> Build application code and docker image</h3> <div class="language-bash extra-class"><pre class="language-bash"><code>$ docker-compose -f src/docker/docker-compose.yml build
</code></pre></div><h3 id="run-the-application-and-the-keycloak-instance"><a href="#run-the-application-and-the-keycloak-instance" class="header-anchor">#</a> Run the application and the keycloak instance</h3> <p>Run the following command to launch the application and the keycloak instance.
The <code>app</code> container will wait until keycloak start and will launch the java application.</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ docker-compose -f src/docker/docker-compose.yml up -d --force-recreate
$ docker-compose -f src/docker/docker-compose.yml logs -f
</code></pre></div><h3 id="_1-check-that-the-keycloak-is-up-and-runnning"><a href="#_1-check-that-the-keycloak-is-up-and-runnning" class="header-anchor">#</a> 1. Check that the keycloak is up and runnning.</h3> <ul><li>You should be able to access <a href="http://localhost:8080/auth/admin/master/console/#/realms/organisation" target="_blank" rel="noopener noreferrer">The organisation realm here<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li>You should be able to access <a href="http://localhost:8080/auth/admin/master/console/#/realms/organisation/clients/0aa973e3-2222-4448-965f-30bd4ec343bc" target="_blank" rel="noopener noreferrer">The client1 client here<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li>You should be able to access <a href="http://localhost:8080/auth/admin/master/console/#/realms/organisation/users" target="_blank" rel="noopener noreferrer">The keycloak users page here<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. Click the <code>View all users</code> button to see users.</li> <li>You should be able to access <a href="http://localhost:8080/auth/admin/master/console/#/realms/organisation/users/680f0684-b324-4a5d-9e96-7b08d448d4cc/role-mappings" target="_blank" rel="noopener noreferrer">The role mappings page here<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> of the user having the login <code>test</code>. Click the <code>Client Roles</code> dropdown and tape <code>client1</code>. You should see that the user have only <code>writer</code> into <code>Assigned Roles</code> select.</li></ul> <h3 id="_2-check-that-application-is-up-and-running"><a href="#_2-check-that-application-is-up-and-running" class="header-anchor">#</a> 2. Check that application is up and running</h3> <blockquote><p>Run the following command to have a shell inside the app container</p></blockquote> <div class="language-bash extra-class"><pre class="language-bash"><code>$ docker-compose -f src/docker/docker-compose.yml <span class="token builtin class-name">exec</span> app <span class="token function">bash</span>

root@fff93b8266a1:/sources<span class="token comment">#</span>
</code></pre></div><blockquote><p>Always inside the <code>app</code> container, run this command to test that the public endpoint is up and running.</p></blockquote> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">curl</span> <span class="token string">&quot;localhost:8081/&quot;</span> -s
Hello Public Ok
</code></pre></div><h2 id="test-stack"><a href="#test-stack" class="header-anchor">#</a> Test stack</h2> <h3 id="_1-generate-a-jwt-token"><a href="#_1-generate-a-jwt-token" class="header-anchor">#</a> 1. Generate a JWT token :</h3> <blockquote><p>Always inside the <code>app</code> container, using the following command generate a JWT token of the user <code>test</code></p></blockquote> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">curl</span> -s -d <span class="token string">'client_id=client1'</span> <span class="token punctuation">\</span>
    -d <span class="token string">'client_secret=7926b321-48ef-4ba9-9c57-ee9c98de7dd6'</span> <span class="token punctuation">\</span>
    -d <span class="token string">'username=test'</span> <span class="token punctuation">\</span>
    -d <span class="token string">'password=password'</span> <span class="token punctuation">\</span>
    -d <span class="token string">'grant_type=password'</span> <span class="token punctuation">\</span>
    <span class="token string">'http://keycloak:8080/auth/realms/organisation/protocol/openid-connect/token'</span> <span class="token punctuation">\</span>
    <span class="token operator">|</span> jq .access_token -r
</code></pre></div><p>You can decode the generated token using <a href="https://jwt.io/" target="_blank" rel="noopener noreferrer">jwt.io web site<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h3 id="_2-redirect-to-login-page-anonymous-user"><a href="#_2-redirect-to-login-page-anonymous-user" class="header-anchor">#</a> 2. Redirect to login page anonymous user</h3> <blockquote><p>Always inside the <code>app</code> container, run this command to test that the private endpoint is secured. Without bearer user is redirected to the keycloak login page.</p></blockquote> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">curl</span> <span class="token string">&quot;localhost:8081/api/private&quot;</span> -vL

<span class="token operator">&lt;</span> HTTP/1.1 <span class="token number">302</span> 
<span class="token operator">&lt;</span> X-Content-Type-Options: nosniff
<span class="token operator">&lt;</span> X-XSS-Protection: <span class="token number">1</span><span class="token punctuation">;</span> <span class="token assign-left variable">mode</span><span class="token operator">=</span>block
<span class="token operator">&lt;</span> Cache-Control: no-cache, no-store, max-age<span class="token operator">=</span><span class="token number">0</span>, must-revalidate
<span class="token operator">&lt;</span> Pragma: no-cache
<span class="token operator">&lt;</span> Expires: <span class="token number">0</span>
<span class="token operator">&lt;</span> X-Frame-Options: DENY
<span class="token operator">&lt;</span> Location: http://localhost:8081/oauth2/authorization/organisation
<span class="token operator">&lt;</span> Content-Length: <span class="token number">0</span>
<span class="token operator">&lt;</span> Date: Sat, <span class="token number">18</span> Apr <span class="token number">2020</span> <span class="token number">15</span>:37:56 GMT
<span class="token operator">&lt;</span> 
* Connection <span class="token comment">#0 to host localhost left intact</span>
* Issue another request to this URL: <span class="token string">'http://localhost:8081/oauth2/authorization/organisation'</span>
* Found bundle <span class="token keyword">for</span> <span class="token function">host</span> localhost: 0x56357c93b980 <span class="token punctuation">[</span>can pipeline<span class="token punctuation">]</span>
* Could pipeline, but not asked to<span class="token operator">!</span>
* Re-using existing connection<span class="token operator">!</span> <span class="token punctuation">(</span><span class="token comment">#0) with host localhost</span>
* Connected to localhost <span class="token punctuation">(</span><span class="token number">127.0</span>.0.1<span class="token punctuation">)</span> port <span class="token number">8081</span> <span class="token punctuation">(</span><span class="token comment">#0)</span>
* Expire <span class="token keyword">in</span> <span class="token number">0</span> ms <span class="token keyword">for</span> <span class="token number">6</span> <span class="token punctuation">(</span>transfer 0x56357c940f50<span class="token punctuation">)</span>
<span class="token operator">&gt;</span> GET /oauth2/authorization/organisation HTTP/1.1
<span class="token operator">&gt;</span> Host: localhost:8081
<span class="token operator">&gt;</span> User-Agent: curl/7.64.0
<span class="token operator">&gt;</span> Accept: */*
<span class="token operator">&gt;</span> 
<span class="token operator">&lt;</span> HTTP/1.1 <span class="token number">302</span> 
<span class="token operator">&lt;</span> Set-Cookie: <span class="token assign-left variable">JSESSIONID</span><span class="token operator">=</span>FE73A1CFE7BBC8D92843240E2C14D54A<span class="token punctuation">;</span> <span class="token assign-left variable">Path</span><span class="token operator">=</span>/<span class="token punctuation">;</span> HttpOnly
<span class="token operator">&lt;</span> X-Content-Type-Options: nosniff
<span class="token operator">&lt;</span> X-XSS-Protection: <span class="token number">1</span><span class="token punctuation">;</span> <span class="token assign-left variable">mode</span><span class="token operator">=</span>block
<span class="token operator">&lt;</span> Cache-Control: no-cache, no-store, max-age<span class="token operator">=</span><span class="token number">0</span>, must-revalidate
<span class="token operator">&lt;</span> Pragma: no-cache
<span class="token operator">&lt;</span> Expires: <span class="token number">0</span>
<span class="token operator">&lt;</span> X-Frame-Options: DENY
<span class="token operator">&lt;</span> Location: http://keycloak:8080/auth/realms/organisation/protocol/openid-connect/auth?response_type<span class="token operator">=</span>code<span class="token operator">&amp;</span><span class="token assign-left variable">client_id</span><span class="token operator">=</span>client1<span class="token operator">&amp;</span><span class="token assign-left variable">scope</span><span class="token operator">=</span>openid%20profile%20email<span class="token operator">&amp;</span><span class="token assign-left variable">state</span><span class="token operator">=</span>Vursu6cdVMD0_xWBrOYbo-XnWc4Jfkf669IuCZB9jVw%3D<span class="token operator">&amp;</span><span class="token assign-left variable">redirect_uri</span><span class="token operator">=</span>http://localhost:8081/login/oauth2/code/organisation<span class="token operator">&amp;</span><span class="token assign-left variable">nonce</span><span class="token operator">=</span>AfbDVJTZ4TXsdbQilshIx4IzlhW5IwJPnQkr6je1zFI
<span class="token operator">&lt;</span> Content-Length: <span class="token number">0</span>
<span class="token operator">&lt;</span> Date: Sat, <span class="token number">18</span> Apr <span class="token number">2020</span> <span class="token number">15</span>:37:56 GMT
<span class="token operator">&lt;</span> 

</code></pre></div><h3 id="_3-role-are-respected"><a href="#_3-role-are-respected" class="header-anchor">#</a> 3. Role are respected</h3> <blockquote><p>Always inside the <code>app</code> container, run this command to test that</p> <ul><li>With <code>test</code> or <code>test2</code> bearer response is <code>200</code>.</li> <li>With <code>test3</code> bearer response is <code>403</code>.</li></ul></blockquote> <p>The command below is composed by two curl.</p> <ul><li>one curl that generate a jwt token by calling keycloak</li> <li>the second curl use the generated token as a Bearer</li></ul> <h4 id="_3-1-writer-can-read-user-test"><a href="#_3-1-writer-can-read-user-test" class="header-anchor">#</a> 3.1 writer can read (user <code>test</code>)</h4> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">bearer_jwt</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">curl</span> -s <span class="token punctuation">\</span>
        -d <span class="token string">'username=test'</span> <span class="token punctuation">\</span>
        -d <span class="token string">'password=password'</span> <span class="token punctuation">\</span>
        -d <span class="token string">'client_id=client1'</span> <span class="token punctuation">\</span>
        -d <span class="token string">'client_secret=7926b321-48ef-4ba9-9c57-ee9c98de7dd6'</span> <span class="token punctuation">\</span>
        -d <span class="token string">'grant_type=password'</span> <span class="token punctuation">\</span>
        <span class="token string">'http://keycloak:8080/auth/realms/organisation/protocol/openid-connect/token'</span> <span class="token punctuation">\</span>
        <span class="token operator">|</span> jq .access_token -r<span class="token variable">)</span></span> <span class="token punctuation">\</span>
        <span class="token punctuation">\</span>
<span class="token operator">&amp;&amp;</span> <span class="token function">curl</span> -v <span class="token string">'localhost:8081/api/private'</span> <span class="token punctuation">\</span>
    -H <span class="token string">&quot;Authorization: Bearer <span class="token variable">${bearer_jwt}</span>&quot;</span>

</code></pre></div><h4 id="_3-2-reader-can-read-user-test2"><a href="#_3-2-reader-can-read-user-test2" class="header-anchor">#</a> 3.2 reader can read (user <code>test2</code>)</h4> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">bearer_jwt</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">curl</span> -s <span class="token punctuation">\</span>
        -d <span class="token string">'username=test2'</span> <span class="token punctuation">\</span>
        -d <span class="token string">'password=password'</span> <span class="token punctuation">\</span>
        -d <span class="token string">'client_id=client1'</span> <span class="token punctuation">\</span>
        -d <span class="token string">'client_secret=7926b321-48ef-4ba9-9c57-ee9c98de7dd6'</span> <span class="token punctuation">\</span>
        -d <span class="token string">'grant_type=password'</span> <span class="token punctuation">\</span>
        <span class="token string">'http://keycloak:8080/auth/realms/organisation/protocol/openid-connect/token'</span> <span class="token punctuation">\</span>
        <span class="token operator">|</span> jq .access_token -r<span class="token variable">)</span></span> <span class="token punctuation">\</span>
        <span class="token punctuation">\</span>
<span class="token operator">&amp;&amp;</span> <span class="token function">curl</span> -v <span class="token string">'localhost:8081/api/private'</span> <span class="token punctuation">\</span>
    -H <span class="token string">&quot;Authorization: Bearer <span class="token variable">${bearer_jwt}</span>&quot;</span>

</code></pre></div><h4 id="_3-3-other-roles-can-t-read-user-test3"><a href="#_3-3-other-roles-can-t-read-user-test3" class="header-anchor">#</a> 3.3 other roles can't read (user <code>test3</code>)</h4> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">bearer_jwt</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">curl</span> -s <span class="token punctuation">\</span>
        -d <span class="token string">'username=test3'</span> <span class="token punctuation">\</span>
        -d <span class="token string">'password=password'</span> <span class="token punctuation">\</span>
        -d <span class="token string">'client_id=client1'</span> <span class="token punctuation">\</span>
        -d <span class="token string">'client_secret=7926b321-48ef-4ba9-9c57-ee9c98de7dd6'</span> <span class="token punctuation">\</span>
        -d <span class="token string">'grant_type=password'</span> <span class="token punctuation">\</span>
        <span class="token string">'http://keycloak:8080/auth/realms/organisation/protocol/openid-connect/token'</span> <span class="token punctuation">\</span>
        <span class="token operator">|</span> jq .access_token -r<span class="token variable">)</span></span> <span class="token punctuation">\</span>
        <span class="token punctuation">\</span>
<span class="token operator">&amp;&amp;</span> <span class="token function">curl</span> -v <span class="token string">'localhost:8081/api/private'</span> <span class="token punctuation">\</span>
    -H <span class="token string">&quot;Authorization: Bearer <span class="token variable">${bearer_jwt}</span>&quot;</span>

</code></pre></div><blockquote><p>Always inside the <code>app</code> container, run this command to test that</p> <ul><li>With <code>test</code> bearer response is <code>200</code>.</li> <li>With <code>test2</code> or <code>test3</code> bearer response is <code>403</code>.</li></ul></blockquote> <p>The curl here is the same as previous, the only difference is <code>-XPOST</code> which means that we using the verb POST.</p> <h4 id="_3-4-writer-can-write-user-test"><a href="#_3-4-writer-can-write-user-test" class="header-anchor">#</a> 3.4 writer can write (user <code>test</code>)</h4> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">bearer_jwt</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">curl</span> -s <span class="token punctuation">\</span>
        -d <span class="token string">'username=test'</span> <span class="token punctuation">\</span>
        -d <span class="token string">'password=password'</span> <span class="token punctuation">\</span>
        -d <span class="token string">'client_id=client1'</span> <span class="token punctuation">\</span>
        -d <span class="token string">'client_secret=7926b321-48ef-4ba9-9c57-ee9c98de7dd6'</span> <span class="token punctuation">\</span>
        -d <span class="token string">'grant_type=password'</span> <span class="token punctuation">\</span>
        <span class="token string">'http://keycloak:8080/auth/realms/organisation/protocol/openid-connect/token'</span> <span class="token punctuation">\</span>
        <span class="token operator">|</span> jq .access_token -r<span class="token variable">)</span></span> <span class="token punctuation">\</span>
        <span class="token punctuation">\</span>
<span class="token operator">&amp;&amp;</span> <span class="token function">curl</span> -v <span class="token string">'localhost:8081/api/private'</span> -XPOST <span class="token punctuation">\</span>
    -H <span class="token string">&quot;Authorization: Bearer <span class="token variable">${bearer_jwt}</span>&quot;</span>

</code></pre></div><h4 id="_3-5-other-roles-can-t-write-user-test2-and-user-test3"><a href="#_3-5-other-roles-can-t-write-user-test2-and-user-test3" class="header-anchor">#</a> 3.5 other roles can't write (user <code>test2</code> and user <code>test3</code>)</h4> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">bearer_jwt</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">curl</span> -s <span class="token punctuation">\</span>
        -d <span class="token string">'username=test2'</span> <span class="token punctuation">\</span>
        -d <span class="token string">'password=password'</span> <span class="token punctuation">\</span>
        -d <span class="token string">'client_id=client1'</span> <span class="token punctuation">\</span>
        -d <span class="token string">'client_secret=7926b321-48ef-4ba9-9c57-ee9c98de7dd6'</span> <span class="token punctuation">\</span>
        -d <span class="token string">'grant_type=password'</span> <span class="token punctuation">\</span>
        <span class="token string">'http://keycloak:8080/auth/realms/organisation/protocol/openid-connect/token'</span> <span class="token punctuation">\</span>
        <span class="token operator">|</span> jq .access_token -r<span class="token variable">)</span></span> <span class="token punctuation">\</span>
        <span class="token punctuation">\</span>
<span class="token operator">&amp;&amp;</span> <span class="token function">curl</span> -v <span class="token string">'localhost:8081/api/private'</span> -XPOST <span class="token punctuation">\</span>
    -H <span class="token string">&quot;Authorization: Bearer <span class="token variable">${bearer_jwt}</span>&quot;</span>

</code></pre></div><div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">bearer_jwt</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">curl</span> -s <span class="token punctuation">\</span>
        -d <span class="token string">'username=test3'</span> <span class="token punctuation">\</span>
        -d <span class="token string">'password=password'</span> <span class="token punctuation">\</span>
        -d <span class="token string">'client_id=client1'</span> <span class="token punctuation">\</span>
        -d <span class="token string">'client_secret=7926b321-48ef-4ba9-9c57-ee9c98de7dd6'</span> <span class="token punctuation">\</span>
        -d <span class="token string">'grant_type=password'</span> <span class="token punctuation">\</span>
        <span class="token string">'http://keycloak:8080/auth/realms/organisation/protocol/openid-connect/token'</span> <span class="token punctuation">\</span>
        <span class="token operator">|</span> jq .access_token -r<span class="token variable">)</span></span> <span class="token punctuation">\</span>
        <span class="token punctuation">\</span>
<span class="token operator">&amp;&amp;</span> <span class="token function">curl</span> -v <span class="token string">'localhost:8081/api/private'</span> -XPOST <span class="token punctuation">\</span>
    -H <span class="token string">&quot;Authorization: Bearer <span class="token variable">${bearer_jwt}</span>&quot;</span>

</code></pre></div><h2 id="code-explanation"><a href="#code-explanation" class="header-anchor">#</a> Code explanation</h2> <h3 id="_1-protect-the-application-with-an-openid-provider"><a href="#_1-protect-the-application-with-an-openid-provider" class="header-anchor">#</a> 1. Protect the application with an OpenId provider</h3> <p>Spring Security provide the starter <code>spring-boot-starter-oauth2-client</code> that activate protection of the application using Oauth and Openid Connect proovider.
it support Google / Facebook / Github or custom provider</p> <ul><li>by default all endpoints are secured</li> <li>token is stored into HttpSession.</li> <li>authentification by Authorization header is not supported</li> <li>roles based access is not supported</li></ul> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-oauth2-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>Adding this dependency will not have effect until the <code>spring.security.oauth2.client.registration</code> configuration is added</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">security</span><span class="token punctuation">:</span>
    <span class="token key atrule">oauth2</span><span class="token punctuation">:</span>
      <span class="token key atrule">client</span><span class="token punctuation">:</span>
        <span class="token key atrule">registration</span><span class="token punctuation">:</span> 
          <span class="token key atrule">organisation</span><span class="token punctuation">:</span> 
            <span class="token key atrule">client-id</span><span class="token punctuation">:</span> client1
            <span class="token comment"># client-name: client1</span>
            <span class="token key atrule">client-secret</span><span class="token punctuation">:</span> 7926b321<span class="token punctuation">-</span>48ef<span class="token punctuation">-</span>4ba9<span class="token punctuation">-</span>9c57<span class="token punctuation">-</span>ee9c98de7dd6
            <span class="token comment"># client-authentication-method:</span>
            <span class="token key atrule">authorization-grant-type</span><span class="token punctuation">:</span> authorization_code
            <span class="token comment"># http://localhost:8081/login/oauth2/code/organisation</span>
            <span class="token key atrule">redirectUri</span><span class="token punctuation">:</span> <span class="token string">'{baseUrl}/login/oauth2/code/{registrationId}'</span>
            <span class="token key atrule">scope</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> openid
              <span class="token punctuation">-</span> profile
              <span class="token punctuation">-</span> email
        <span class="token key atrule">provider</span><span class="token punctuation">:</span>
          <span class="token key atrule">organisation</span><span class="token punctuation">:</span>
            <span class="token key atrule">issuer-uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//keycloak<span class="token punctuation">:</span>8080/auth/realms/organisation
            <span class="token key atrule">user-name-attribute</span><span class="token punctuation">:</span> preferred_username
</code></pre></div><h3 id="_2-add-authentification-based-on-authorization-header"><a href="#_2-add-authentification-based-on-authorization-header" class="header-anchor">#</a> 2. Add authentification based on Authorization header</h3> <p>Spring Security provide the <code>spring-security-oauth2-resource-server</code> lib that implement a <a href="https://www.oauth.com/oauth2-servers/the-resource-server/" target="_blank" rel="noopener noreferrer">oauth2 resource server<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. The resource server is the OAuth 2.0 term for your API server. The resource server handles authenticated requests after the application has obtained an access token. This include :</p> <ul><li>Verifying Access Tokens included into HTTP Authorization header</li> <li>Verifying Scope or Roles</li> <li>The following Error codes are implemented
<ul><li>invalid_token (HTTP 401) – The access token is expired, revoked, malformed, or invalid for other reasons. The client can obtain a new access token and try again</li> <li>insufficient_scope (HTTP 403) – The access token is valid but don't contains the right roles</li></ul></li></ul> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.security<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-security-oauth2-resource-server<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

</code></pre></div><p>After adding this dependency you need to define <code>spring.security.oauth2.resourceserver.jwt.issuer-uri</code> or <code>spring.security.oauth2.resourceserver.jwt.jwk-set-uri</code> needed to retrieve the JWK Set and verify the signature of the JWT.</p> <p>Into this example we choose to set the <code>issuer-uri</code></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">security</span><span class="token punctuation">:</span>
    <span class="token key atrule">oauth2</span><span class="token punctuation">:</span>
      <span class="token key atrule">resourceserver</span><span class="token punctuation">:</span>
        <span class="token key atrule">jwt</span><span class="token punctuation">:</span>
          <span class="token key atrule">issuer-uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//keycloak<span class="token punctuation">:</span>8080/auth/realms/organisation
</code></pre></div><h3 id="_3-modify-default-configuration"><a href="#_3-modify-default-configuration" class="header-anchor">#</a> 3. modify default configuration</h3> <p>The default spring security <code>WebSecurityConfigurerAdapter</code> request authentication for any endpoint.</p> <div class="language-java extra-class"><pre class="language-java"><code>	<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
		http
			<span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div><ul><li>To override this behavior, we need to provide a custom WebSecurityConfigurerAdapter class and using <code>@EnableWebSecurity</code> we activate this class.</li> <li>we use the <code>EnableGlobalMethodSecurity</code> annotation to enable the <code>jsr250Enabled</code> support, this is enable the support of <code>@RolesAllowed</code> annotation used into <code>Contoller</code> level.</li> <li><code>SessionCreationPolicy</code> is set to <code>STATELESS</code> to disable HttpSession usage</li> <li>The spring security resource server don't map JWT roles to the spring security principal. So we can't use @Secured or @RolesAllowed to manage endpoints based on JWT roles. To fix that we have to implement a custom <code>jwtAuthenticationConverter</code></li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@EnableWebSecurity</span>
<span class="token annotation punctuation">@EnableGlobalMethodSecurity</span><span class="token punctuation">(</span>
		  jsr250Enabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OAuth2LoginSecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    	http
<span class="token comment">// disable usage of HTTP session to store tokens</span>
            <span class="token punctuation">.</span><span class="token function">sessionManagement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sessionCreationPolicy</span><span class="token punctuation">(</span><span class="token class-name">SessionCreationPolicy</span><span class="token punctuation">.</span>STATELESS<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// configure login with oauth2 client </span>
            <span class="token punctuation">.</span><span class="token function">oauth2Login</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// activate oauth2 resource server that add authentification with 'Authorization: Bearer' header </span>
            <span class="token punctuation">.</span><span class="token function">oauth2ResourceServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            	<span class="token punctuation">.</span><span class="token function">jwt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// add JWT converter to map roles into principal to be able to use into @Secured</span>
            	<span class="token punctuation">.</span><span class="token function">jwtAuthenticationConverter</span><span class="token punctuation">(</span><span class="token function">getJwtAuthenticationConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><h3 id="_4-added-authentication-using-cookie"><a href="#_4-added-authentication-using-cookie" class="header-anchor">#</a> 4. added authentication using cookie</h3> <p>In this step we provide a custom implementation to <code>AuthorizedClientRepository</code>.
We store Access and Refresh token into cookies.
We use an new AuthenticationFilter to attempt authentication using same cookies.</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token function">oauth2Login</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// using custom authorized client repository</span>
<span class="token comment">// that store tokens into cookies</span>
  <span class="token punctuation">.</span><span class="token function">authorizedClientRepository</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cookieAuthorizedClientRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// added filter that attempt authentication using cookie stored by CookieAuthorizedClientRepository</span>
  <span class="token punctuation">.</span><span class="token function">addFilterAfter</span><span class="token punctuation">(</span><span class="token function">getCookieTokenAuthenticationFilter</span><span class="token punctuation">(</span>http<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">BearerTokenAuthenticationFilter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div><p>Always inside the <code>app</code> container, run this command to test this feature</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token builtin class-name">export</span> <span class="token assign-left variable">bearer_jwt</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">curl</span> -s <span class="token punctuation">\</span>
        -d <span class="token string">'username=test'</span> <span class="token punctuation">\</span>
        -d <span class="token string">'password=password'</span> <span class="token punctuation">\</span>
        -d <span class="token string">'client_id=client1'</span> <span class="token punctuation">\</span>
        -d <span class="token string">'client_secret=7926b321-48ef-4ba9-9c57-ee9c98de7dd6'</span> <span class="token punctuation">\</span>
        -d <span class="token string">'grant_type=password'</span> <span class="token punctuation">\</span>
        <span class="token string">'http://keycloak:8080/auth/realms/organisation/protocol/openid-connect/token'</span> <span class="token punctuation">\</span>
        <span class="token operator">|</span> jq .access_token -r<span class="token variable">)</span></span> <span class="token punctuation">\</span>
        <span class="token punctuation">\</span>
<span class="token operator">&amp;&amp;</span> <span class="token function">curl</span> -v <span class="token string">'localhost:8081/api/private'</span> <span class="token punctuation">\</span>
    --cookie <span class="token string">&quot;OIDC_ACCESS_TOKEN=<span class="token variable">${bearer_jwt}</span>&quot;</span>
</code></pre></div><h2 id="reference-documentation"><a href="#reference-documentation" class="header-anchor">#</a> Reference Documentation</h2> <ul><li><a href="https://docs.spring.io/spring-boot/docs/2.2.6.RELEASE/reference/htmlsingle/#boot-features-security-oauth2-client" target="_blank" rel="noopener noreferrer">Spring Security OAuth2 Client<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://docs.spring.io/spring-boot/docs/2.2.6.RELEASE/reference/htmlsingle/#boot-features-security-oauth2-server" target="_blank" rel="noopener noreferrer">Spring Security Resource Server<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://www.oauth.com/oauth2-servers/the-resource-server/" target="_blank" rel="noopener noreferrer">Resource Server Definition<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://www.baeldung.com/spring-security-method-security" target="_blank" rel="noopener noreferrer">Spring Method Security<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <h2 id="launch-into-ide"><a href="#launch-into-ide" class="header-anchor">#</a> Launch into IDE</h2> <p>To launch this application into our IDE you need to do the following steps</p> <ol><li>Launch keycloak using</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code>docker-compose -f src/docker/docker-compose-local.yml up -d
</code></pre></div><ol start="2"><li>Launch you application using the local spring profile.
Here is an exemple using maven and spring-boot:run</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code>./mvnw clean package spring-boot:run -Dspring-boot.run.profiles<span class="token operator">=</span>local 
</code></pre></div><ol start="3"><li>you and test using the following commands</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token builtin class-name">export</span> <span class="token assign-left variable">bearer_jwt</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">curl</span> -s <span class="token punctuation">\</span>
        -d <span class="token string">'username=test'</span> <span class="token punctuation">\</span>
        -d <span class="token string">'password=password'</span> <span class="token punctuation">\</span>
        -d <span class="token string">'client_id=client1'</span> <span class="token punctuation">\</span>
        -d <span class="token string">'client_secret=7926b321-48ef-4ba9-9c57-ee9c98de7dd6'</span> <span class="token punctuation">\</span>
        -d <span class="token string">'grant_type=password'</span> <span class="token punctuation">\</span>
        <span class="token string">'http://localhost:8080/auth/realms/organisation/protocol/openid-connect/token'</span> <span class="token punctuation">\</span>
        <span class="token operator">|</span> jq .access_token -r<span class="token variable">)</span></span> <span class="token punctuation">\</span>
        <span class="token punctuation">\</span>
<span class="token operator">&amp;&amp;</span> <span class="token function">curl</span> -v <span class="token string">'localhost:8081/api/private'</span> <span class="token punctuation">\</span>
    -H <span class="token string">&quot;Authorization: Bearer <span class="token variable">${bearer_jwt}</span>&quot;</span>
</code></pre></div><div class="language-bash extra-class"><pre class="language-bash"><code><span class="token builtin class-name">export</span> <span class="token assign-left variable">bearer_jwt</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">curl</span> -s <span class="token punctuation">\</span>
        -d <span class="token string">'username=test'</span> <span class="token punctuation">\</span>
        -d <span class="token string">'password=password'</span> <span class="token punctuation">\</span>
        -d <span class="token string">'client_id=client1'</span> <span class="token punctuation">\</span>
        -d <span class="token string">'client_secret=7926b321-48ef-4ba9-9c57-ee9c98de7dd6'</span> <span class="token punctuation">\</span>
        -d <span class="token string">'grant_type=password'</span> <span class="token punctuation">\</span>
        <span class="token string">'http://localhost:8080/auth/realms/organisation/protocol/openid-connect/token'</span> <span class="token punctuation">\</span>
        <span class="token operator">|</span> jq .access_token -r<span class="token variable">)</span></span> <span class="token punctuation">\</span>
        <span class="token punctuation">\</span>
<span class="token operator">&amp;&amp;</span> <span class="token function">curl</span> -v <span class="token string">'localhost:8081/api/private'</span> <span class="token punctuation">\</span>
    --cookie <span class="token string">&quot;OIDC_ACCESS_TOKEN=<span class="token variable">${bearer_jwt}</span>&quot;</span>


</code></pre></div><h2 id="source-code"><a href="#source-code" class="header-anchor">#</a> Source code</h2> <p><a href="https://github.com/mohamedelhabib/demo-openid-connect" target="_blank" rel="noopener noreferrer">https://github.com/mohamedelhabib/demo-openid-connect<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="todo"><a href="#todo" class="header-anchor">#</a> TODO</h2> <ul><li>howto to manage refresh token</li> <li>redirect to the original url after login success</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.8bb2a787.js" defer></script><script src="/assets/js/4.c6323ad2.js" defer></script><script src="/assets/js/2.79e1ebb6.js" defer></script><script src="/assets/js/10.efdfd574.js" defer></script><script src="/assets/js/6.d7f91b89.js" defer></script>
  </body>
</html>
