<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Kubernetes Istio Into local environment with k3d | Enjoy Technology</title>
    <meta name="generator" content="VuePress 1.5.0">
    <link rel="manifest" href="/assets/manifest.json">
    <link rel="apple-touch-icon" sizes="57x57" href="/assets/icons/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/assets/icons/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/assets/icons/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/assets/icons/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/assets/icons/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/assets/icons/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/assets/icons/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/assets/icons/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/assets/icons/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/icons/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/assets/icons/favicon-96x96.png">
    <link rel="preconnect" href="https://www.google-analytics.com">
    <link rel="preconnect" href="https://storage.googleapis.com">
    <meta name="description" content="A set of posts to share technology finding and help to get started">
    <meta name="theme-color" content="#ffffff">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Enjoy Technology">
    <meta name="application-name" content="Enjoy Technology">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-config" content="/assets/ieconfig.xml">
    <meta name="msapplication-TileImage" content="/assets/icons/ms-icon-144x144.png">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="google-site-verification" content="vaHfBtNF19BYEIpHn505BzxJ8a6lWlV6JO2GOdqptfY">
    <link rel="preload" href="/assets/css/0.styles.05b5abf3.css" as="style"><link rel="preload" href="/assets/js/app.8bb2a787.js" as="script"><link rel="preload" href="/assets/js/4.c6323ad2.js" as="script"><link rel="preload" href="/assets/js/2.79e1ebb6.js" as="script"><link rel="preload" href="/assets/js/12.cd13affe.js" as="script"><link rel="preload" href="/assets/js/6.d7f91b89.js" as="script"><link rel="prefetch" href="/assets/js/10.efdfd574.js"><link rel="prefetch" href="/assets/js/11.af07a843.js"><link rel="prefetch" href="/assets/js/13.39b88b44.js"><link rel="prefetch" href="/assets/js/14.a9fa26a6.js"><link rel="prefetch" href="/assets/js/15.c0b71d42.js"><link rel="prefetch" href="/assets/js/3.8bab5a9e.js"><link rel="prefetch" href="/assets/js/5.f132e9b5.js"><link rel="prefetch" href="/assets/js/7.ada2a324.js"><link rel="prefetch" href="/assets/js/8.724a125e.js"><link rel="prefetch" href="/assets/js/9.2d0a0718.js">
    <link rel="stylesheet" href="/assets/css/0.styles.05b5abf3.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/assets/icons/favicon-32x32.png" alt="Enjoy Technology" class="logo"> <span class="site-name can-hide">Enjoy Technology</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Kubernetes Istio Into local environment with k3d</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/2020/05/15/kubernetes-istio-into-local-environment-with-k3d/#introduction" class="sidebar-link">Introduction</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/2020/05/15/kubernetes-istio-into-local-environment-with-k3d/#what-is-k3s-the-official-definition" class="sidebar-link">What is k3s (the official definition)</a></li><li class="sidebar-sub-header"><a href="/2020/05/15/kubernetes-istio-into-local-environment-with-k3d/#what-is-k3d" class="sidebar-link">What is k3d</a></li></ul></li><li><a href="/2020/05/15/kubernetes-istio-into-local-environment-with-k3d/#requirements" class="sidebar-link">Requirements</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/2020/05/15/kubernetes-istio-into-local-environment-with-k3d/#install-k3d" class="sidebar-link">Install k3d</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/2020/05/15/kubernetes-istio-into-local-environment-with-k3d/#create-a-cluster" class="sidebar-link">Create a cluster</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/2020/05/15/kubernetes-istio-into-local-environment-with-k3d/#generate-kubectl-configuration" class="sidebar-link">Generate kubectl configuration</a></li><li class="sidebar-sub-header"><a href="/2020/05/15/kubernetes-istio-into-local-environment-with-k3d/#check-that-the-cluster-is-running" class="sidebar-link">Check that the cluster is running</a></li></ul></li><li><a href="/2020/05/15/kubernetes-istio-into-local-environment-with-k3d/#build-and-deploy-demo-application" class="sidebar-link">Build and deploy demo application</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/2020/05/15/kubernetes-istio-into-local-environment-with-k3d/#create-a-demo-application" class="sidebar-link">Create a demo application</a></li><li class="sidebar-sub-header"><a href="/2020/05/15/kubernetes-istio-into-local-environment-with-k3d/#build-the-demo-application" class="sidebar-link">Build the demo application</a></li><li class="sidebar-sub-header"><a href="/2020/05/15/kubernetes-istio-into-local-environment-with-k3d/#deploy-the-demo-application" class="sidebar-link">Deploy the demo application</a></li></ul></li><li><a href="/2020/05/15/kubernetes-istio-into-local-environment-with-k3d/#deploy-istio-into-k3d" class="sidebar-link">Deploy Istio into k3d</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/2020/05/15/kubernetes-istio-into-local-environment-with-k3d/#what-is-istio" class="sidebar-link">What is Istio</a></li><li class="sidebar-sub-header"><a href="/2020/05/15/kubernetes-istio-into-local-environment-with-k3d/#disable-k3s-load-balancer-service" class="sidebar-link">Disable k3s load balancer service</a></li><li class="sidebar-sub-header"><a href="/2020/05/15/kubernetes-istio-into-local-environment-with-k3d/#download-and-extract-istio" class="sidebar-link">Download and extract Istio</a></li><li class="sidebar-sub-header"><a href="/2020/05/15/kubernetes-istio-into-local-environment-with-k3d/#create-a-namespace-for-istio" class="sidebar-link">Create a namespace for istio</a></li><li class="sidebar-sub-header"><a href="/2020/05/15/kubernetes-istio-into-local-environment-with-k3d/#install-istio-init" class="sidebar-link">Install istio-init</a></li><li class="sidebar-sub-header"><a href="/2020/05/15/kubernetes-istio-into-local-environment-with-k3d/#install-istio" class="sidebar-link">Install Istio</a></li><li class="sidebar-sub-header"><a href="/2020/05/15/kubernetes-istio-into-local-environment-with-k3d/#test-with-istio-demo-application" class="sidebar-link">Test with istio demo application</a></li><li class="sidebar-sub-header"><a href="/2020/05/15/kubernetes-istio-into-local-environment-with-k3d/#acces-kiali-dashboard" class="sidebar-link">Acces Kiali dashboard</a></li></ul></li><li><a href="/2020/05/15/kubernetes-istio-into-local-environment-with-k3d/#use-isto-for-the-demo-application" class="sidebar-link">Use Isto for the demo application</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/2020/05/15/kubernetes-istio-into-local-environment-with-k3d/#enable-istio-injection-into-demo-app" class="sidebar-link">Enable istio-injection into demo-app</a></li><li class="sidebar-sub-header"><a href="/2020/05/15/kubernetes-istio-into-local-environment-with-k3d/#configuring-ingress-using-an-istio-gateway" class="sidebar-link">Configuring ingress using an Istio gateway</a></li><li class="sidebar-sub-header"><a href="/2020/05/15/kubernetes-istio-into-local-environment-with-k3d/#api-versionning" class="sidebar-link">Api versionning</a></li></ul></li><li><a href="/2020/05/15/kubernetes-istio-into-local-environment-with-k3d/#references" class="sidebar-link">References</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> <footer class="footer" data-v-d9212786><ul class="sidebar-social" data-v-d9212786><li class="contact-item" data-v-d9212786><a href="https://github.com/mohamedelhabib" title="github" data-v-d9212786><svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github" data-v-d9212786 data-v-d9212786><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22" data-v-d9212786 data-v-d9212786></path></svg>
        github
      </a></li><li class="contact-item" data-v-d9212786><a href="https://twitter.com/elhabib_med" title="twitter" data-v-d9212786><svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-twitter" data-v-d9212786 data-v-d9212786><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z" data-v-d9212786 data-v-d9212786></path></svg>
        twitter
      </a></li><li class="contact-item" data-v-d9212786><a href="https://www.linkedin.com/in/mohamed-el-habib-77165222" title="linkedin" data-v-d9212786><svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-linkedin" data-v-d9212786 data-v-d9212786><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z" data-v-d9212786 data-v-d9212786></path><rect x="2" y="9" width="4" height="12" data-v-d9212786 data-v-d9212786></rect><circle cx="4" cy="4" r="2" data-v-d9212786 data-v-d9212786></circle></svg>
        linkedin
      </a></li></ul> <div class="copyright" data-v-d9212786>MIT Licensed | Copyright © 2020-present</div></footer></aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="introduction"><a href="#introduction" class="header-anchor">#</a> Introduction</h2> <p>To run a Kubernetes into local machine you have several options.</p> <ul><li><code>Minikube</code> is a virtual machine based solution.</li> <li><code>Microk8s</code> is a snap package, available only in Ubuntu and compatible distributions</li> <li><code>Docker Desktop</code> is an application for MacOS and Windows machines</li></ul> <p>I this article we explore another option, <a href="https://github.com/rancher/k3d" target="_blank" rel="noopener noreferrer">k3d<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> a docker version of <code>k3s</code>, the lightweight Kubernetes distribution by Rancher.</p> <h3 id="what-is-k3s-the-official-definition"><a href="#what-is-k3s-the-official-definition" class="header-anchor">#</a> What is k3s (the official definition)</h3> <p><code>k3s</code> is a fully compliant Kubernetes distribution with the following changes:</p> <ol><li>Packaged as a single binary.</li> <li>Lightweight storage backend based on sqlite3 as the default storage mechanism. etcd3, MySQL, Postgres also still available.</li> <li>Wrapped in simple launcher that handles a lot of the complexity of TLS and options.</li> <li>Secure by default with reasonable defaults for lightweight environments.</li> <li>Minimal to no OS dependencies (just a sane kernel and cgroup mounts needed). k3s packages required
dependencies
<ul><li>containerd</li> <li>Flannel</li> <li>CoreDNS</li> <li>CNI</li> <li>Host utilities (iptables, socat, etc)</li> <li>Ingress controller (traefik)</li> <li>Embedded service loadbalancer</li> <li>Embedded network policy controller</li></ul></li></ol> <h3 id="what-is-k3d"><a href="#what-is-k3d" class="header-anchor">#</a> What is k3d</h3> <p><code>k3d</code> is a <code>Go</code> binary file that run <code>k3s</code> in docker. A very simple installation way and no modification in your system just one docker container that contain the Kubernetes cluster.</p> <h2 id="requirements"><a href="#requirements" class="header-anchor">#</a> Requirements</h2> <ul><li>docker</li> <li>kubectl</li> <li>java</li> <li><a href="https://helm.sh/docs/intro/install/" target="_blank" rel="noopener noreferrer">helm<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <h2 id="install-k3d"><a href="#install-k3d" class="header-anchor">#</a> Install k3d</h2> <p>The installation script <code>install.sh</code> will run the following steps</p> <div class="language-bash extra-class"><pre class="language-bash"><code>initArch <span class="token comment"># discovers the architecture for this system</span>
initOS <span class="token comment"># discovers the operating system for this system</span>
verifySupported <span class="token comment"># checks that the os/arch combination is supported for binary builds</span>
checkTagProvided <span class="token operator">||</span> checkLatestVersion
<span class="token keyword">if</span> <span class="token operator">!</span> checkK3dInstalledVersion<span class="token punctuation">;</span> <span class="token keyword">then</span>
  downloadFile <span class="token comment"># downloads the latest binary package and also the checksum</span>
  installFile <span class="token comment"># make the Go binary file executable and mv it to /usr/local/bin/.</span>
<span class="token keyword">fi</span>
</code></pre></div><div class="language-bash extra-class"><pre class="language-bash"><code><span class="token builtin class-name">:</span><span class="token variable">${K3D_INSTALL_DIR<span class="token operator">:=</span>&quot;<span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>bin&quot;}</span>
<span class="token punctuation">..</span>.
<span class="token function-name function">installFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token builtin class-name">echo</span> <span class="token string">&quot;Preparing to install <span class="token variable">$APP_NAME</span> into <span class="token variable">${K3D_INSTALL_DIR}</span>&quot;</span>
  runAsRoot <span class="token function">chmod</span> +x <span class="token string">&quot;<span class="token variable">$K3D_TMP_FILE</span>&quot;</span>
  runAsRoot <span class="token function">cp</span> <span class="token string">&quot;<span class="token variable">$K3D_TMP_FILE</span>&quot;</span> <span class="token string">&quot;<span class="token variable">$K3D_INSTALL_DIR</span>/<span class="token variable">$APP_NAME</span>&quot;</span>
  <span class="token builtin class-name">echo</span> <span class="token string">&quot;<span class="token variable">$APP_NAME</span> installed into <span class="token variable">$K3D_INSTALL_DIR</span>/<span class="token variable">$APP_NAME</span>&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>To install <code>k3d</code> run the following command</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ <span class="token function">curl</span> -s https://raw.githubusercontent.com/rancher/k3d/v1.7.0/install.sh <span class="token operator">|</span> <span class="token function">bash</span>
</code></pre></div><h2 id="create-a-cluster"><a href="#create-a-cluster" class="header-anchor">#</a> Create a cluster</h2> <p>To create a Kubernetes cluster run the following command</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ k3d create
INFO<span class="token punctuation">[</span>0000<span class="token punctuation">]</span> Created cluster network with ID aa64941776d3cfd783189cbb46c0abbee89074228d3f88d7748d17f28cc9f0ca 
INFO<span class="token punctuation">[</span>0000<span class="token punctuation">]</span> Created docker volume  k3d-k3s-default-images 
INFO<span class="token punctuation">[</span>0000<span class="token punctuation">]</span> Creating cluster <span class="token punctuation">[</span>k3s-default<span class="token punctuation">]</span>               
INFO<span class="token punctuation">[</span>0000<span class="token punctuation">]</span> Creating server using docker.io/rancher/k3s:v1.17.3-k3s1<span class="token punctuation">..</span>. 
INFO<span class="token punctuation">[</span>0000<span class="token punctuation">]</span> Pulling image docker.io/rancher/k3s:v1.17.3-k3s1<span class="token punctuation">..</span>. 
INFO<span class="token punctuation">[</span>0006<span class="token punctuation">]</span> SUCCESS: created cluster <span class="token punctuation">[</span>k3s-default<span class="token punctuation">]</span>       
INFO<span class="token punctuation">[</span>0006<span class="token punctuation">]</span> You can now use the cluster with:

<span class="token builtin class-name">export</span> <span class="token assign-left variable">KUBECONFIG</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable"><span class="token variable">$(</span>k3d get-kubeconfig --name<span class="token operator">=</span><span class="token string">'k3s-default'</span><span class="token variable">)</span></span>&quot;</span>
kubectl cluster-info 
</code></pre></div><p>If you run the following command you can see that there are a <code>k3s</code> docker image just pulled.</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ docker <span class="token function">ps</span> <span class="token operator">|</span> <span class="token function">grep</span> k3s
b0c341cbee7a        rancher/k3s:v1.17.3-k3s1   <span class="token string">&quot;/bin/k3s server --h…&quot;</span>   <span class="token number">2</span> minutes ago       Up <span class="token number">2</span> minutes        <span class="token number">0.0</span>.0.0:6443-<span class="token operator">&gt;</span><span class="token number">6443</span>/tcp   k3d-k3s-default-server
</code></pre></div><p>If you run the following command you can see that there are a <code>k3d-k3s...</code> container running.</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ docker <span class="token function">ps</span>
CONTAINER ID        IMAGE                      COMMAND                  CREATED             STATUS              PORTS                    NAMES
b0c341cbee7a        rancher/k3s:v1.17.3-k3s1   <span class="token string">&quot;/bin/k3s server --h…&quot;</span>   <span class="token number">2</span> minutes ago       Up About a minute   <span class="token number">0.0</span>.0.0:6443-<span class="token operator">&gt;</span><span class="token number">6443</span>/tcp   k3d-k3s-default-server
</code></pre></div><h3 id="generate-kubectl-configuration"><a href="#generate-kubectl-configuration" class="header-anchor">#</a> Generate kubectl configuration</h3> <p>To user the Kubernetes cluster we need to tell kubectl where to find the config file.
<code>k3d</code> a command to get the config file location</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ k3d get-kubeconfig --name<span class="token operator">=</span><span class="token string">'k3s-default'</span>
/home/<span class="token punctuation">..</span><span class="token punctuation">..</span>/.config/k3d/k3s-default/kubeconfig.yaml
</code></pre></div><p>We set this path into <code>KUBECONFIG</code> kubectl environment variable</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">KUBECONFIG</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable"><span class="token variable">$(</span>k3d get-kubeconfig --name<span class="token operator">=</span><span class="token string">'k3s-default'</span><span class="token variable">)</span></span>&quot;</span>
</code></pre></div><h3 id="check-that-the-cluster-is-running"><a href="#check-that-the-cluster-is-running" class="header-anchor">#</a> Check that the cluster is running</h3> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl get pod,svc --all-namespaces
NAMESPACE     NAME                                          READY   STATUS      RESTARTS   AGE
kube-system   pod/local-path-provisioner-58fb86bdfd-qrmmv   <span class="token number">1</span>/1     Running     <span class="token number">0</span>          23m
kube-system   pod/metrics-server-6d684c7b5-qk4pl            <span class="token number">1</span>/1     Running     <span class="token number">0</span>          23m
kube-system   pod/helm-install-traefik-qb7mn                <span class="token number">0</span>/1     Completed   <span class="token number">0</span>          23m
kube-system   pod/svclb-traefik-748m5                       <span class="token number">2</span>/2     Running     <span class="token number">0</span>          23m
kube-system   pod/coredns-d798c9dd-tth8c                    <span class="token number">1</span>/1     Running     <span class="token number">0</span>          23m
kube-system   pod/traefik-6787cddb4b-qswjk                  <span class="token number">1</span>/1     Running     <span class="token number">0</span>          23m

NAMESPACE     NAME                         TYPE           CLUSTER-IP     EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>                      AGE
default       service/kubernetes           ClusterIP      <span class="token number">10.43</span>.0.1      <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">443</span>/TCP                      23m
kube-system   service/kube-dns             ClusterIP      <span class="token number">10.43</span>.0.10     <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">53</span>/UDP,53/TCP,9153/TCP       23m
kube-system   service/metrics-server       ClusterIP      <span class="token number">10.43</span>.94.13    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">443</span>/TCP                      23m
kube-system   service/traefik-prometheus   ClusterIP      <span class="token number">10.43</span>.110.75   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">9100</span>/TCP                     23m
kube-system   service/traefik              LoadBalancer   <span class="token number">10.43</span>.54.34    <span class="token number">172.19</span>.0.2    <span class="token number">80</span>:32219/TCP,443:32350/TCP   23m
</code></pre></div><h2 id="build-and-deploy-demo-application"><a href="#build-and-deploy-demo-application" class="header-anchor">#</a> Build and deploy demo application</h2> <h3 id="create-a-demo-application"><a href="#create-a-demo-application" class="header-anchor">#</a> Create a demo application</h3> <p>Create an new spring-boot application using https://start.spring.io/.
For this tuto we will use an already prepared application from <code>demo-app</code> folder.</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># checkout the 1.0 tag</span>
$ <span class="token function">git</span> checkout <span class="token number">1.0</span>
</code></pre></div><p>At this step we have a very simple spring-boot application with</p> <ul><li><code>spring-boot-starter-web</code> to run a tomcat server</li> <li><code>spring-boot-starter-actuator</code> to get /actuator/info endpoint</li></ul> <p>We are using the <code>jib-maven-plugin</code> to generate the docker image. Please see the pom.xml for more details.</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ tree <span class="token builtin class-name">.</span>
<span class="token builtin class-name">.</span>
├── HELP.md
├── k8s
│   ├── 01_namespace.yml
│   ├── 02_deployment.yml
│   └── 03_service.yml
├── mvnw
├── mvnw.cmd
├── pom.xml
└── src
    ├── main
    │   ├── java
    │   │   └── com
    │   │       └── example
    │   │           └── demoistio
    │   │               └── DemoIstioApplication.java
    │   └── resources
    │       └── application.properties
    └── <span class="token builtin class-name">test</span>
        └── java
            └── com
                └── example
                    └── demoistio
                        └── DemoIstioApplicationTests.java

</code></pre></div><h3 id="build-the-demo-application"><a href="#build-the-demo-application" class="header-anchor">#</a> Build the demo application</h3> <p>To build the application jar and docker image run the following command</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ ./mvnw clean package
</code></pre></div><p>You can check that there are a docker image <code>com.example/demo-app</code></p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ docker image <span class="token function">ls</span> <span class="token operator">|</span> <span class="token function">grep</span> demo
com.example/demo-app          <span class="token number">1.0</span>                     486ace0e9548        <span class="token number">50</span> years ago        383MB
</code></pre></div><p>To deploy our application into the Kubernetes cluster we have to make our local image available into the cluster.
This can be done by push the image to a remote docker registry or by using the import-images</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ k3d import-images com.example/demo-app:1.0
INFO<span class="token punctuation">[</span>0000<span class="token punctuation">]</span> Saving images <span class="token punctuation">[</span>com.example/demo-app:1.0<span class="token punctuation">]</span> from <span class="token builtin class-name">local</span> docker daemon<span class="token punctuation">..</span>. 
INFO<span class="token punctuation">[</span>0000<span class="token punctuation">]</span> Pulling image docker.io/iwilltry42/k3d-tools:v0.0.1<span class="token punctuation">..</span>. 
INFO<span class="token punctuation">[</span>0006<span class="token punctuation">]</span> Saved images to shared docker volume         
INFO<span class="token punctuation">[</span>0006<span class="token punctuation">]</span> Importing images <span class="token punctuation">[</span>com.example/demo-app:1.0<span class="token punctuation">]</span> <span class="token keyword">in</span> container <span class="token punctuation">[</span>k3d-k3s-default-server<span class="token punctuation">]</span> 
INFO<span class="token punctuation">[</span>0011<span class="token punctuation">]</span> Successfully imported images <span class="token punctuation">[</span>com.example/demo-app:1.0<span class="token punctuation">]</span> <span class="token keyword">in</span> all nodes of cluster <span class="token punctuation">[</span>k3s-default<span class="token punctuation">]</span> 
INFO<span class="token punctuation">[</span>0011<span class="token punctuation">]</span> Cleaning up tarball                          
INFO<span class="token punctuation">[</span>0011<span class="token punctuation">]</span> Deleted tarball                              
INFO<span class="token punctuation">[</span>0011<span class="token punctuation">]</span> <span class="token punctuation">..</span>.Done 
</code></pre></div><h3 id="deploy-the-demo-application"><a href="#deploy-the-demo-application" class="header-anchor">#</a> Deploy the demo application</h3> <p>Into k8s folder you can the k8s manifest we will use to deploy.<br>
The demo-app will be deployed into namespace <code>api</code></p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ tree k8s/
k8s/
<span class="token comment"># manifest to create the `api` namespace</span>
├── 01_namespace.yml
<span class="token comment"># manifest to create deploy container using the demo-app docker image</span>
├── 02_deployment.yml
<span class="token comment"># manifest to create a Kubernetes service </span>
└── 03_service.yml
</code></pre></div><p>Fill free to check the content of YAML file</p> <p>Run the following command to  deploy and wait to deployment to finish.
Wait until you see <code>1/1</code> into READY columns, Tape <code>CTRL+C</code> to stop waiting.</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl apply -R -f k8s <span class="token operator">&amp;&amp;</span> kubectl -n api get pods -w
namespace/api created
deployment.apps/demo-app-deployment created
service/demo-app-service created
NAME                                  READY   STATUS              RESTARTS   AGE
demo-app-deployment-f444966fd-4qh5n   <span class="token number">0</span>/1     ContainerCreating   <span class="token number">0</span>          0s
demo-app-deployment-f444966fd-4qh5n   <span class="token number">0</span>/1   Running   <span class="token number">0</span>     2s
demo-app-deployment-f444966fd-4qh5n   <span class="token number">1</span>/1   Running   <span class="token number">0</span>     5s
</code></pre></div><p>To check pod is running and service is there run the following command</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl -n api get pods,svc
NAME                                      READY   STATUS    RESTARTS   AGE
pod/demo-app-deployment-f444966fd-l6hn9   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          6m52s

NAME                       TYPE        CLUSTER-IP     EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>   AGE
service/demo-app-service   ClusterIP   <span class="token number">10.43</span>.10.248   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">80</span>/TCP    6m52s
</code></pre></div><p>To check that application is running, we connect to the server docker container and run a simple http request.</p> <blockquote><p>NOTE that 10.43.10.248 is the IP show into CLUSTER-IP into previous command</p></blockquote> <div class="language-shell extra-class"><pre class="language-shell"><code>$ docker <span class="token builtin class-name">exec</span> -ti k3d-k3s-default-server <span class="token function">sh</span> -c <span class="token string">&quot;wget -qSO- 10.43.10.248/actuator/info&quot;</span>
  HTTP/1.1 <span class="token number">200</span> 
  Content-Type: application/vnd.spring-boot.actuator.v3+json
  Transfer-Encoding: chunked
  Date: Fri, <span class="token number">15</span> May <span class="token number">2020</span> 04:13:56 GMT
  Connection: close
  
<span class="token punctuation">{</span><span class="token string">&quot;git&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;branch&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;67f84b9744d014f558b95fb521266fa4fb00501a&quot;</span>,<span class="token string">&quot;commit&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;id&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;67f84b9&quot;</span>,<span class="token string">&quot;time&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;2019-12-05T12:04:13Z&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre></div><h2 id="deploy-istio-into-k3d"><a href="#deploy-istio-into-k3d" class="header-anchor">#</a> Deploy Istio into k3d</h2> <h3 id="what-is-istio"><a href="#what-is-istio" class="header-anchor">#</a> What is Istio</h3> <p>Istio provides behavioural insights and operational control over the service mesh as a whole, offering a complete solution to satisfy the diverse requirements of microservice applications.
Read more about provided features here https://istio.io/docs/concepts/what-is-istio/</p> <h3 id="disable-k3s-load-balancer-service"><a href="#disable-k3s-load-balancer-service" class="header-anchor">#</a> Disable <code>k3s</code> load balancer service</h3> <p><code>k3s</code> and <code>k3d</code> come with preconfigured load balancer service, this is fine for default usage, but to be able de use istio we have to disable this service.
Unfortunately <code>k3s</code> don't provide an update cluster option, so we have to recreate the cluster. More details into this github issue https://github.com/rancher/k3d/issues/104</p> <p>Hopefully this very easy and quick to do.</p> <p>Run this command to delete the cluster.</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ k3d delete
INFO<span class="token punctuation">[</span>0000<span class="token punctuation">]</span> Removing cluster <span class="token punctuation">[</span>k3s-default<span class="token punctuation">]</span>               
INFO<span class="token punctuation">[</span>0000<span class="token punctuation">]</span> <span class="token punctuation">..</span>.Removing server                           
INFO<span class="token punctuation">[</span>0002<span class="token punctuation">]</span> <span class="token punctuation">..</span>.Removing docker image volume              
INFO<span class="token punctuation">[</span>0002<span class="token punctuation">]</span> Removed cluster <span class="token punctuation">[</span>k3s-default<span class="token punctuation">]</span>    
</code></pre></div><p>Run this command to create the cluster without the load balancer service.</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ k3d create --server-arg --no-deploy --server-arg servicelb
</code></pre></div><p>Run the following commands to deploy the application</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ k3d import-images com.example/demo-app:1.0
$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">KUBECONFIG</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable"><span class="token variable">$(</span>k3d get-kubeconfig --name<span class="token operator">=</span><span class="token string">'k3s-default'</span><span class="token variable">)</span></span>&quot;</span>
$ kubectl apply -R -f k8s <span class="token operator">&amp;&amp;</span> kubectl -n api get pods -w
</code></pre></div><h3 id="download-and-extract-istio"><a href="#download-and-extract-istio" class="header-anchor">#</a> Download and extract Istio</h3> <div class="language-shell extra-class"><pre class="language-shell"><code>$ <span class="token function">curl</span> https://github.com/istio/istio/releases/download/1.5.4/istio-1.5.4-linux.tar.gz -L <span class="token operator">|</span> <span class="token function">tar</span> xvz
</code></pre></div><h3 id="create-a-namespace-for-istio"><a href="#create-a-namespace-for-istio" class="header-anchor">#</a> Create a namespace for istio</h3> <div class="language-shell extra-class"><pre class="language-shell"><code>$ <span class="token builtin class-name">cd</span> istio-1.5.4
$ kubectl create namespace istio-system
namespace/istio-system created
</code></pre></div><h3 id="install-istio-init"><a href="#install-istio-init" class="header-anchor">#</a> Install istio-init</h3> <div class="language-shell extra-class"><pre class="language-shell"><code>$ helm template istio-init install/kubernetes/helm/istio-init  --namespace istio-system <span class="token operator">|</span> kubectl apply -f -
serviceaccount/istio-init-service-account created
configmap/istio-crd-all created
configmap/istio-crd-mixer created
clusterrole.rbac.authorization.k8s.io/istio-init-istio-system created
clusterrolebinding.rbac.authorization.k8s.io/istio-init-admin-role-binding-istio-system created
job.batch/istio-init-crd-all-1.5.4 created
job.batch/istio-init-crd-mixer-1.5.4 created

<span class="token comment"># Wait that `istio-init-crd` are `Completed` </span>
$ kubectl get pod,svc -n istio-system 
NAME                                   READY   STATUS      RESTARTS   AGE
pod/istio-init-crd-mixer-1.5.4-6hjst   <span class="token number">0</span>/1     Completed   <span class="token number">0</span>          50s
pod/istio-init-crd-all-1.5.4-qlfdp     <span class="token number">0</span>/1     Completed   <span class="token number">0</span>          50s
</code></pre></div><h3 id="install-istio"><a href="#install-istio" class="header-anchor">#</a> Install Istio</h3> <p>At this step we will install Istio with <code>Kiali</code> (an observability console for Istio).</p> <p>To activate this console we need to provide a login/password</p> <p>Using kubectl we create a <code>Keberntes Secret</code> containing the username and passphrase for <code>Kiali</code></p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ <span class="token function">cat</span> <span class="token operator">&lt;&lt;</span>EOF <span class="token operator">|</span> kubectl apply -f -
apiVersion: v1
kind: Secret
metadata:
  name: kiali
  namespace: istio-system
  labels:
    app: kiali
type: Opaque
data:
  username: <span class="token assign-left variable">YWRtaW4</span><span class="token operator">=</span>
  passphrase: <span class="token assign-left variable">YWRtaW4</span><span class="token operator">=</span>
EOF
</code></pre></div><p>Using helm we deploy the chart of <code>Istio</code></p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ helm template istio install/kubernetes/helm/istio --namespace istio-system --set kiali.enabled<span class="token operator">=</span>true <span class="token operator">|</span> kubectl apply -f -
oddisruptionbudget.policy/istio-galley created
poddisruptionbudget.policy/istio-ingressgateway created
poddisruptionbudget.policy/istio-policy created
poddisruptionbudget.policy/istio-telemetry created
poddisruptionbudget.policy/istio-pilot created
poddisruptionbudget.policy/istio-citadel created
poddisruptionbudget.policy/istio-sidecar-injector created
<span class="token punctuation">..</span>.
<span class="token punctuation">..</span>.
rule.config.istio.io/promhttp created
rule.config.istio.io/promtcp created
rule.config.istio.io/promtcpconnectionopen created
rule.config.istio.io/promtcpconnectionclosed created
rule.config.istio.io/kubeattrgenrulerule created
rule.config.istio.io/tcpkubeattrgenrulerule created
job.batch/istio-security-post-install-1.5.4 created
</code></pre></div><p>check that every thing is OK (status should be Completed or Running)</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl get pod,svc -n istio-system 
NAME                                          READY   STATUS      RESTARTS   AGE
pod/istio-init-crd-mixer-1.5.4-t5mjk          <span class="token number">0</span>/1     Completed   <span class="token number">0</span>          111s
pod/istio-init-crd-all-1.5.4-7phvs            <span class="token number">0</span>/1     Completed   <span class="token number">0</span>          111s
pod/istio-citadel-5449c98845-cf7bb            <span class="token number">1</span>/1     Running     <span class="token number">0</span>          55s
pod/svclb-istio-ingressgateway-czd64          <span class="token number">9</span>/9     Running     <span class="token number">0</span>          55s
pod/istio-telemetry-85c9dfddb7-nx42k          <span class="token number">2</span>/2     Running     <span class="token number">1</span>          55s
pod/istio-policy-5db987b9dc-mmzgk             <span class="token number">2</span>/2     Running     <span class="token number">1</span>          55s
pod/istio-galley-554d6d4cfb-sjq87             <span class="token number">1</span>/1     Running     <span class="token number">0</span>          55s
pod/kiali-9fc79f8b8-rxc7n                     <span class="token number">1</span>/1     Running     <span class="token number">0</span>          55s
pod/istio-sidecar-injector-85b6d84b84-72cfj   <span class="token number">1</span>/1     Running     <span class="token number">0</span>          54s
pod/prometheus-794594dc97-s5p2g               <span class="token number">1</span>/1     Running     <span class="token number">0</span>          55s
pod/istio-security-post-install-1.5.4-krv64   <span class="token number">0</span>/1     Completed   <span class="token number">0</span>          35s
pod/istio-pilot-786558d87b-hrs9f              <span class="token number">2</span>/2     Running     <span class="token number">2</span>          55s
pod/istio-ingressgateway-644cd99cfd-xsl6m     <span class="token number">1</span>/1     Running     <span class="token number">0</span>          55s

NAME                             TYPE           CLUSTER-IP      EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>                                                                                                                                      AGE
service/istio-galley             ClusterIP      <span class="token number">10.43</span>.62.172    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">443</span>/TCP,15014/TCP,9901/TCP                                                                                                                   55s
service/kiali                    ClusterIP      <span class="token number">10.43</span>.55.178    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">20001</span>/TCP                                                                                                                                    55s
service/istio-policy             ClusterIP      <span class="token number">10.43</span>.81.255    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">9091</span>/TCP,15004/TCP,15014/TCP                                                                                                                 55s
service/istio-telemetry          ClusterIP      <span class="token number">10.43</span>.48.138    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">9091</span>/TCP,15004/TCP,15014/TCP,42422/TCP                                                                                                       55s
service/istio-pilot              ClusterIP      <span class="token number">10.43</span>.33.93     <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">15010</span>/TCP,15011/TCP,8080/TCP,15014/TCP                                                                                                       55s
service/prometheus               ClusterIP      <span class="token number">10.43</span>.82.109    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">9090</span>/TCP                                                                                                                                     55s
service/istio-citadel            ClusterIP      <span class="token number">10.43</span>.177.192   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">8060</span>/TCP,15014/TCP                                                                                                                           55s
service/istio-sidecar-injector   ClusterIP      <span class="token number">10.43</span>.31.119    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">443</span>/TCP,15014/TCP                                                                                                                            55s
service/istio-ingressgateway     LoadBalancer   <span class="token number">10.43</span>.105.148   <span class="token number">172.21</span>.0.2    <span class="token number">15020</span>:30892/TCP,80:31380/TCP,443:31390/TCP,31400:31400/TCP,15029:31994/TCP,15030:32199/TCP,15031:30538/TCP,15032:30545/TCP,15443:30726/TCP   55s

</code></pre></div><h3 id="test-with-istio-demo-application"><a href="#test-with-istio-demo-application" class="header-anchor">#</a> Test with istio demo application</h3> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl label namespace default istio-injection<span class="token operator">=</span>enabled
$ kubectl apply -f samples/bookinfo/platform/kube/bookinfo.yaml
$ kubectl get pods -w
$ kubectl apply -f samples/bookinfo/networking/bookinfo-gateway.yaml
$ kubectl get svc  -n istio-system istio-ingressgateway -o <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">'{.status.loadBalancer.ingress[0].ip}'</span>
</code></pre></div><p>Goto this url to check istio demo working <a href="">http://{The IP Address}/productpage</a>
Refersh several time and you should see three version of the review star</p> <ul><li>black</li> <li>orange</li> <li>and none
In fact the istio bookinfo application contains three versions of the review service</li></ul> <h3 id="acces-kiali-dashboard"><a href="#acces-kiali-dashboard" class="header-anchor">#</a> Acces Kiali dashboard</h3> <p>Run this command to access the <code>Kiali</code> dashboard. it will create a port forward and open the right url into navigator.</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ ./bin/istioctl dashboard kiali
</code></pre></div><p>You should see some thing like this.</p> <ul><li>1 application into <code>api</code> namespace, ower demo application</li> <li>4 application into <code>default</code>, the istio demo application</li> <li>10 application into <code>istio-system</code>, the istio container</li></ul> <p><img src="/assets/img/kiali-dashboard.png" alt=""></p> <h2 id="use-isto-for-the-demo-application"><a href="#use-isto-for-the-demo-application" class="header-anchor">#</a> Use Isto for the demo application</h2> <h3 id="enable-istio-injection-into-demo-app"><a href="#enable-istio-injection-into-demo-app" class="header-anchor">#</a> Enable <code>istio-injection</code> into <code>demo-app</code></h3> <p>Into this version <code>1.0-istio-injectio-on</code> we enable the <code>istio-injection</code> by added a label into namespace <code>api</code></p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ <span class="token function">git</span> checkout <span class="token number">1.0</span>-istio-injectio-on

$ <span class="token function">git</span> <span class="token function">diff</span> <span class="token number">1.0</span><span class="token punctuation">..</span><span class="token number">1.0</span>-istio-injectio-on 
<span class="token function">diff</span> --git a/k8s/01_namespace.yml b/k8s/01_namespace.yml
index b61d02d<span class="token punctuation">..</span>6bd1bae <span class="token number">100644</span>
--- a/k8s/01_namespace.yml
+++ b/k8s/01_namespace.yml
@@ -2,7 +2,7 @@
 apiVersion: v1
 kind: Namespace
 metadata:
-  <span class="token comment"># labels:</span>
-  <span class="token comment">#   # enable istio injection into the new namespace</span>
-  <span class="token comment">#   istio-injection: enabled</span>
-  name: api
<span class="token punctuation">\</span> No newline at end of <span class="token function">file</span>
+  labels:
+    <span class="token comment"># enable istio injection into the new namespace</span>
+    istio-injection: enabled
+  name: api
</code></pre></div><p>When we apply this modification, we can see that only namespace change
pod is not updated.</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl apply -R -f k8s <span class="token operator">&amp;&amp;</span> kubectl -n api get pods
namespace/api configured
deployment.apps/demo-app-deployment unchanged
service/demo-app-service unchanged
NAME                                  READY   STATUS    RESTARTS   AGE
demo-app-deployment-f444966fd-4qh5n   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          61m
</code></pre></div><p>We need to restart pods to make the change applied. There are no restart command provided by kubectl. To achieve that we patch the deployment by adding a label this will make k8s create a new revision with the same image version</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl patch -n api deployment demo-app-deployment -p   <span class="token string">&quot;{<span class="token entity" title="\&quot;">\&quot;</span>spec<span class="token entity" title="\&quot;">\&quot;</span>:{<span class="token entity" title="\&quot;">\&quot;</span>template<span class="token entity" title="\&quot;">\&quot;</span>:{<span class="token entity" title="\&quot;">\&quot;</span>metadata<span class="token entity" title="\&quot;">\&quot;</span>:{<span class="token entity" title="\&quot;">\&quot;</span>annotations<span class="token entity" title="\&quot;">\&quot;</span>:{<span class="token entity" title="\&quot;">\&quot;</span>restart_date<span class="token entity" title="\&quot;">\&quot;</span>:<span class="token entity" title="\&quot;">\&quot;</span><span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +<span class="token string">'%s'</span><span class="token variable">)</span></span><span class="token entity" title="\&quot;">\&quot;</span>}}}}}&quot;</span>

deployment.apps/demo-app-deployment patched

$ kubectl -n api get pods 
NAME                                   READY   STATUS    RESTARTS   AGE
demo-app-deployment-577f556689-tlpnn   <span class="token number">2</span>/2     Running   <span class="token number">0</span>          18s
</code></pre></div><p>You can see that the pod name has changed and under <code>READY</code> we have <code>2/2</code> instead of <code>1/1</code>.
We can see that there are a new container called <code>istio-proxy</code></p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl -n api get pods demo-app-deployment-577f556689-tlpnn -o json <span class="token operator">|</span> jq -r .spec.containers<span class="token punctuation">[</span><span class="token punctuation">]</span>.name
demo-app
istio-proxy
</code></pre></div><h3 id="configuring-ingress-using-an-istio-gateway"><a href="#configuring-ingress-using-an-istio-gateway" class="header-anchor">#</a> Configuring ingress using an Istio gateway</h3> <p>To expose the <code>demo-app</code> outside the k8s cluster we need an <code>Istio Gateway</code> and an <code>Istio VirtualService</code>. An ingress Gateway describes a load balancer operating at the edge of the mesh that receives incoming HTTP/TCP connections. It configures exposed ports, protocols, etc. but, unlike Kubernetes Ingress Resources, does not include any traffic routing configuration. Traffic routing for ingress traffic is instead configured using Istio routing rules, exactly in the same way as for internal service requests.</p> <div class="language-shell extra-class"><pre class="language-shell"><code>$ <span class="token function">git</span> checkout <span class="token number">1.0</span>-istio-gateway-as-ingress
</code></pre></div><p>This version add a new file k8s/04_gateway.yml, that contains the definition of the <code>demo-app-gateway</code> and the <code>demo-app-route</code>. We only expose the <code>/actuator/*</code> endpoints.</p> <h4 id="apply-changes"><a href="#apply-changes" class="header-anchor">#</a> Apply changes</h4> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl apply -R -f k8s 
namespace/api unchanged
deployment.apps/demo-app-deployment unchanged
service/demo-app-service unchanged
gateway.networking.istio.io/demo-app-gateway created
virtualservice.networking.istio.io/demo-app-route created

</code></pre></div><h4 id="check-that-gateway-is-there"><a href="#check-that-gateway-is-there" class="header-anchor">#</a> check that gateway is there</h4> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl get gateway -n api
NAME               AGE
demo-app-gateway   77s

</code></pre></div><h4 id="check-that-virtualservice-is-there"><a href="#check-that-virtualservice-is-there" class="header-anchor">#</a> check that virtualservice is there</h4> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl get virtualservices.networking.istio.io -n api
NAME             GATEWAYS             HOSTS   AGE
demo-app-route   <span class="token punctuation">[</span>demo-app-gateway<span class="token punctuation">]</span>   <span class="token punctuation">[</span>*<span class="token punctuation">]</span>     89s

</code></pre></div><h4 id="get-the-external-ip-of-the-istio-ingressgateway"><a href="#get-the-external-ip-of-the-istio-ingressgateway" class="header-anchor">#</a> get the external IP of the istio-ingressgateway</h4> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl get svc  -n istio-system istio-ingressgateway -o <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">'{.status.loadBalancer.ingress[0].ip}'</span>
<span class="token number">172.24</span>.0.2

</code></pre></div><h4 id="check-that-demo-app-is-accessible-from-outsie-the-k8s-cluster"><a href="#check-that-demo-app-is-accessible-from-outsie-the-k8s-cluster" class="header-anchor">#</a> check that <code>demo-app</code> is accessible from outsie the k8s cluster</h4> <div class="language-shell extra-class"><pre class="language-shell"><code>$ <span class="token function">curl</span> -v -s <span class="token number">172.24</span>.0.2/actuator/info
*   Trying <span class="token number">172.24</span>.0.2:80<span class="token punctuation">..</span>.
* TCP_NODELAY <span class="token builtin class-name">set</span>
* Connected to <span class="token number">172.24</span>.0.2 <span class="token punctuation">(</span><span class="token number">172.24</span>.0.2<span class="token punctuation">)</span> port <span class="token number">80</span> <span class="token punctuation">(</span><span class="token comment">#0)</span>
<span class="token operator">&gt;</span> GET /actuator/info HTTP/1.1
<span class="token operator">&gt;</span> Host: <span class="token number">172.24</span>.0.2
<span class="token operator">&gt;</span> User-Agent: curl/7.65.3
<span class="token operator">&gt;</span> Accept: */*
<span class="token operator">&gt;</span> 
* Mark bundle as not supporting multiuse
<span class="token operator">&lt;</span> HTTP/1.1 <span class="token number">200</span> OK
<span class="token operator">&lt;</span> content-type: application/vnd.spring-boot.actuator.v3+json
<span class="token operator">&lt;</span> date: Thu, 05 Dec <span class="token number">2019</span> <span class="token number">16</span>:02:39 GMT
<span class="token operator">&lt;</span> x-envoy-upstream-service-time: <span class="token number">3</span>
<span class="token operator">&lt;</span> server: istio-envoy
<span class="token operator">&lt;</span> transfer-encoding: chunked
<span class="token operator">&lt;</span> 
* Connection <span class="token comment">#0 to host 172.24.0.2 left intact</span>
<span class="token punctuation">{</span><span class="token string">&quot;git&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;branch&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;67f84b9744d014f558b95fb521266fa4fb00501a&quot;</span>,<span class="token string">&quot;commit&quot;</span>:<span class="token punctuation">{</span><span class="token string">&quot;id&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;67f84b9&quot;</span>,<span class="token string">&quot;time&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;2019-12-05T12:04:13Z&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre></div><h3 id="api-versionning"><a href="#api-versionning" class="header-anchor">#</a> Api versionning</h3> <h4 id="version-1"><a href="#version-1" class="header-anchor">#</a> Version 1</h4> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">git</span> checkout <span class="token number">1.1</span>
</code></pre></div><p>This version contains a new Rest endpoint that generate a random name.</p> <h5 id="build-the-version-1-1-of-the-docker-image"><a href="#build-the-version-1-1-of-the-docker-image" class="header-anchor">#</a> build the version 1.1 of the docker image</h5> <div class="language-shell extra-class"><pre class="language-shell"><code>$ ./mvnw clean package

$ docker image <span class="token function">ls</span> <span class="token operator">|</span> <span class="token function">grep</span> demo
com.example/demo-app          <span class="token number">1.0</span>                     486ace0e9548        <span class="token number">50</span> years ago        383MB
com.example/demo-app          <span class="token number">1.1</span>                     05a5c689c1b7        <span class="token number">50</span> years ago        385MB
</code></pre></div><blockquote><p>the deployment.yml reference now the 1.1 version of the image.
We need to import this new version into k3s cluster.
We have to update the <code>virtualservice</code> to be able to reach the new '/v1/hello' endpoint</p></blockquote> <div class="language-shell extra-class"><pre class="language-shell"><code>$ k3d import-images com.example/demo-app:1.1

</code></pre></div><h5 id="deploy-version-1-1"><a href="#deploy-version-1-1" class="header-anchor">#</a> Deploy version 1.1</h5> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl apply -R -f k8s
namespace/api unchanged
deployment.apps/demo-app-deployment configured
service/demo-app-service unchanged
gateway.networking.istio.io/demo-app-gateway unchanged
virtualservice.networking.istio.io/demo-app-route configured

$ <span class="token function">curl</span> -v -s <span class="token number">172.24</span>.0.2/v1/hello
*   Trying <span class="token number">172.24</span>.0.2:80<span class="token punctuation">..</span>.
* TCP_NODELAY <span class="token builtin class-name">set</span>
* Connected to <span class="token number">172.24</span>.0.2 <span class="token punctuation">(</span><span class="token number">172.24</span>.0.2<span class="token punctuation">)</span> port <span class="token number">80</span> <span class="token punctuation">(</span><span class="token comment">#0)</span>
<span class="token operator">&gt;</span> GET /v1/hello HTTP/1.1
<span class="token operator">&gt;</span> Host: <span class="token number">172.24</span>.0.2
<span class="token operator">&gt;</span> User-Agent: curl/7.65.3
<span class="token operator">&gt;</span> Accept: */*
<span class="token operator">&gt;</span> 
* Mark bundle as not supporting multiuse
<span class="token operator">&lt;</span> HTTP/1.1 <span class="token number">200</span> OK
<span class="token operator">&lt;</span> content-type: text/plain<span class="token punctuation">;</span><span class="token assign-left variable">charset</span><span class="token operator">=</span>UTF-8
<span class="token operator">&lt;</span> content-length: <span class="token number">18</span>
<span class="token operator">&lt;</span> date: Thu, 05 Dec <span class="token number">2019</span> <span class="token number">17</span>:52:10 GMT
<span class="token operator">&lt;</span> x-envoy-upstream-service-time: <span class="token number">5</span>
<span class="token operator">&lt;</span> server: istio-envoy
<span class="token operator">&lt;</span> 
* Connection <span class="token comment">#0 to host 172.24.0.2 left intact</span>
Hello, Mel Maggio<span class="token operator">!</span>
</code></pre></div><h4 id="version-1-and-version-2-canary-release"><a href="#version-1-and-version-2-canary-release" class="header-anchor">#</a> Version 1 and Version 2 canary release</h4> <p>When migrating from version 1 to version 2 of an API, We need to give time to client of this API to migrate, So we need to have the two version of API running together.
To do that we will have to deployment, one for each version.</p> <h5 id="get-version-1-2-code"><a href="#get-version-1-2-code" class="header-anchor">#</a> Get version 1.2 code</h5> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">git</span> checkout <span class="token number">1.2</span>
</code></pre></div><blockquote><p>Note the <code>version</code> label: this is very important for Istio to distinguish between the two deployments</p></blockquote> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> demo<span class="token punctuation">-</span>app<span class="token punctuation">-</span>deployment<span class="token punctuation">-</span>v1
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
<span class="token punctuation">...</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> demo<span class="token punctuation">-</span>app
        <span class="token key atrule">version</span><span class="token punctuation">:</span> v1.1
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> demo<span class="token punctuation">-</span>app
        <span class="token key atrule">image</span><span class="token punctuation">:</span> com.example/demo<span class="token punctuation">-</span>app<span class="token punctuation">:</span><span class="token number">1.1</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> demo<span class="token punctuation">-</span>app<span class="token punctuation">-</span>deployment<span class="token punctuation">-</span>v2
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
<span class="token punctuation">...</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> demo<span class="token punctuation">-</span>app
        <span class="token key atrule">version</span><span class="token punctuation">:</span> v1.2
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> demo<span class="token punctuation">-</span>app
        <span class="token key atrule">image</span><span class="token punctuation">:</span> com.example/demo<span class="token punctuation">-</span>app<span class="token punctuation">:</span><span class="token number">1.2</span>
</code></pre></div><p>No big change to do into the kubernetes <code>service</code></p> <blockquote><p>Note that the port is named (“name: http”). This is a requirement for Istio.</p></blockquote> <blockquote><p>The selector is only using the <code>demo-app</code> label. Without Istio it will distribute traffic between the two deployments evenly.</p></blockquote> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> api
  <span class="token key atrule">name</span><span class="token punctuation">:</span> demo<span class="token punctuation">-</span>app<span class="token punctuation">-</span>service
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> demo<span class="token punctuation">-</span>app
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> http
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> demo<span class="token punctuation">-</span>app
</code></pre></div><p>For <code>VirtualService</code> side, we use the subset. A subset/version of a route destination is identified with a reference to a named service subset which must be declared in a corresponding DestinationRule.</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code>  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">uri</span><span class="token punctuation">:</span>
        <span class="token key atrule">prefix</span><span class="token punctuation">:</span> /v1
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> demo<span class="token punctuation">-</span>app<span class="token punctuation">-</span>service
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
        <span class="token key atrule">port</span><span class="token punctuation">:</span>
          <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">uri</span><span class="token punctuation">:</span>
        <span class="token key atrule">prefix</span><span class="token punctuation">:</span> /v2
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> demo<span class="token punctuation">-</span>app<span class="token punctuation">-</span>service
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v2
        <span class="token key atrule">port</span><span class="token punctuation">:</span>
          <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
</code></pre></div><p>And here the definition of DestinationRule that make the mapping between <code>Sebset/version</code> and <code>pods/version</code></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> demo<span class="token punctuation">-</span>app<span class="token punctuation">-</span>rules
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> api
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">host</span><span class="token punctuation">:</span> demo<span class="token punctuation">-</span>app<span class="token punctuation">-</span>service
  <span class="token key atrule">subsets</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v1
    <span class="token key atrule">labels</span><span class="token punctuation">:</span>
      <span class="token key atrule">version</span><span class="token punctuation">:</span> v1
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v2
    <span class="token key atrule">labels</span><span class="token punctuation">:</span>
      <span class="token key atrule">version</span><span class="token punctuation">:</span> v2

</code></pre></div><h5 id="build-the-version-1-2-of-the-docker-image"><a href="#build-the-version-1-2-of-the-docker-image" class="header-anchor">#</a> Build the version 1.2 of the docker image</h5> <div class="language-shell extra-class"><pre class="language-shell"><code>$ ./mvnw clean package
$ k3d import-images com.example/demo-app:1.2
</code></pre></div><h5 id="deploy-version-1-2-and-1-1"><a href="#deploy-version-1-2-and-1-1" class="header-anchor">#</a> Deploy version 1.2 and 1.1</h5> <div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl apply -R -f k8s
namespace/api unchanged
deployment.apps/demo-app-deployment-v1 created
deployment.apps/demo-app-deployment-v2 created
service/demo-app-service configured
gateway.networking.istio.io/demo-app-gateway unchanged
virtualservice.networking.istio.io/demo-app-route configured
destinationrule.networking.istio.io/demo-app-rules created
</code></pre></div><div class="language-shell extra-class"><pre class="language-shell"><code>$ kubectl apply -R -f k8s <span class="token operator">&amp;&amp;</span> kubectl -n api get pods
namespace/api unchanged
deployment.apps/demo-app-deployment-v1 unchanged
deployment.apps/demo-app-deployment-v2 unchanged
service/demo-app-service unchanged
gateway.networking.istio.io/demo-app-gateway unchanged
virtualservice.networking.istio.io/demo-app-route unchanged
destinationrule.networking.istio.io/demo-app-rules unchanged
NAME                                      READY   STATUS    RESTARTS   AGE
demo-app-deployment-c644498c8-6gln5       <span class="token number">2</span>/2     Running   <span class="token number">0</span>          27m
demo-app-deployment-v1-5fb699f946-j5vrg   <span class="token number">2</span>/2     Running   <span class="token number">0</span>          94s
demo-app-deployment-v2-5b7dd595fb-45lzp   <span class="token number">2</span>/2     Running   <span class="token number">0</span>          94s
</code></pre></div><h2 id="references"><a href="#references" class="header-anchor">#</a> References</h2> <ul><li><a href="https://dev.to/bufferings/tried-k8s-istio-in-my-local-machine-with-k3d-52gg" target="_blank" rel="noopener noreferrer">Tried k8s + Istio on my laptop with k3d<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://haralduebele.blog/2019/03/11/managing-microservices-traffic-with-istio/" target="_blank" rel="noopener noreferrer">Managing Microservices Traffic with Istio<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://istio.io/docs/" target="_blank" rel="noopener noreferrer">Istio Docs<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.8bb2a787.js" defer></script><script src="/assets/js/4.c6323ad2.js" defer></script><script src="/assets/js/2.79e1ebb6.js" defer></script><script src="/assets/js/12.cd13affe.js" defer></script><script src="/assets/js/6.d7f91b89.js" defer></script>
  </body>
</html>
